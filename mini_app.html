<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Nano Banano ¬∑ AI</title>
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800;900&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#070707;--deep:#0F0F0F;
  --s1:rgba(255,255,255,.03);--s2:rgba(255,255,255,.06);--s3:rgba(255,255,255,.1);
  --bd:rgba(255,255,255,.07);--bd2:rgba(255,255,255,.14);
  --y:#B8FF00;--yd:rgba(184,255,0,.1);--yb:rgba(184,255,0,.25);
  --bl:#FF4D6D;--bld:rgba(255,77,109,.1);--blb:rgba(255,77,109,.25);
  --wh:#F2F2F2;--mu:rgba(255,255,255,.55);--mu2:rgba(255,255,255,.32);
  --red:#FF4D6D;--gr:#B8FF00;
  --r:8px;--rsm:5px;
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
html,body{width:100%;min-height:100vh;font-family:'DM Sans',sans-serif;background:var(--bg);color:var(--wh);overflow-x:hidden}

/* ‚îÄ‚îÄ CANVAS ‚îÄ‚îÄ */
#bgc{position:fixed;inset:0;z-index:0;pointer-events:none}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.app{position:relative;z-index:1;display:flex;flex-direction:column;min-height:100vh}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.hdr{
  position:sticky;top:0;z-index:60;
  height:52px;display:flex;align-items:center;justify-content:space-between;
  padding:0 14px;
  background:rgba(5,5,5,.88);
  border-bottom:1px solid rgba(255,255,255,.1);
  box-shadow:0 1px 20px rgba(0,0,0,.6);
}
.logo{display:flex;align-items:center;gap:0;cursor:default;letter-spacing:-0.5px}
.logo-mark{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;color:var(--y);line-height:1}
.logo-dot{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;color:rgba(255,255,255,.2);line-height:1;margin:0 1px}
.logo-mark2{font-family:'Barlow Condensed',sans-serif;font-size:22px;font-weight:900;color:#fff;line-height:1;letter-spacing:.5px}
.logo-hex{display:none}
@keyframes hp{0%,100%{box-shadow:0 0 10px rgba(245,200,0,.3)}50%{box-shadow:0 0 22px rgba(245,200,0,.6),0 0 40px rgba(245,200,0,.12)}}
.logo-t{font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:700;letter-spacing:2px;color:var(--y)}
.hdr-r{display:flex;align-items:center;gap:6px}

/* gen + buy pill */
.gen-wrap{display:flex;align-items:center;background:var(--yd);border:1px solid var(--yb);border-radius:20px;overflow:hidden}
.gen-count{display:flex;align-items:center;gap:5px;padding:5px 10px 5px 12px;font-size:13px;font-weight:600;color:var(--y);cursor:default}
.gen-buy{height:100%;padding:5px 11px;background:var(--y);color:#000;font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:.8px;cursor:pointer;border:none;transition:opacity .15s;border-left:1px solid rgba(0,0,0,.15)}
.gen-buy:hover{opacity:.85}

.ic-btn{width:32px;height:32px;border-radius:50%;border:1px solid var(--bd);background:var(--s1);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .18s}
.ic-btn:hover{border-color:var(--y);background:var(--yd)}
.ic-btn svg{width:14px;height:14px;stroke:var(--mu);fill:none;transition:stroke .18s}
.ic-btn:hover svg{stroke:var(--y)}
.ic-btn.hidden{display:none}

/* ‚îÄ‚îÄ SIGNATURE / FOOTER ‚îÄ‚îÄ */
.app-signature{
  display:none;
  pointer-events:none;white-space:nowrap;
  display:inline-flex;align-items:center;gap:6px;
  background:rgba(255,255,255,.06);
  backdrop-filter:blur(12px);
  border:1px solid rgba(255,255,255,.1);
  border-radius:20px;
  padding:4px 14px;
  font-family:'Barlow Condensed',sans-serif;
  font-size:12px;font-weight:700;letter-spacing:1.5px;
  color:rgba(255,255,255,.35);
}
.app-signature span{color:var(--y);opacity:.8;letter-spacing:1px;}
.app-signature::before{content:'‚óà';font-size:9px;color:rgba(184,255,0,.5)}

/* ‚îÄ‚îÄ MAIN NAV ‚îÄ‚îÄ */
.mainnav{
  display:flex;align-items:stretch;justify-content:center;gap:4px;
  position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:60;
  background:rgba(10,10,10,.92);
  border:1px solid rgba(255,255,255,.12);
  border-radius:24px;padding:6px 8px 8px;
  box-shadow:0 12px 40px rgba(0,0,0,.8),0 0 0 1px rgba(255,255,255,.04),inset 0 1px 0 rgba(255,255,255,.06);
}
.nav-indicator{display:none}
.navbtn{
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:2px;
  min-width:56px;height:auto;padding:8px 6px 10px;
  border:none;background:none;color:var(--mu);cursor:pointer;
  position:relative;transition:color .2s,background .2s,transform .15s;
  border-radius:16px;flex:1;max-width:72px;
}
.navbtn svg{width:22px;height:22px;stroke:currentColor;fill:none;flex-shrink:0;transition:all .2s}
.navbtn .nav-lbl{font-size:11px;font-weight:600;letter-spacing:.3px;opacity:.95;white-space:nowrap;transition:color .2s}
.navbtn.on{
  color:#070707;background:var(--y);
  box-shadow:0 0 18px rgba(184,255,0,.55),0 0 36px rgba(184,255,0,.25);
  animation:navpulse 2.2s ease-in-out infinite;
}
.navbtn.on .nav-lbl{color:#070707 !important}
.navbtn.on svg{stroke:#070707}
.navbtn:active:not(.on){transform:scale(.86);background:rgba(255,255,255,.08)}
/* —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –°–æ–∑–¥–∞—Ç—å */
.navbtn-create{
  position:relative;
}
.navbtn-create>svg{
  width:26px;height:26px;
  background:var(--y);
  border-radius:50%;
  padding:5px;
  stroke:#000 !important;
  box-shadow:0 0 16px rgba(184,255,0,.5);
  transition:all .2s;
}
.navbtn-create.on>svg{
  background:rgba(184,255,0,.2);
  stroke:#000 !important;
  box-shadow:none;
}
.navbtn-create:not(.on):hover>svg{
  box-shadow:0 0 24px rgba(184,255,0,.7);
}
@keyframes navpulse{
  0%,100%{box-shadow:0 0 14px rgba(184,255,0,.45),0 0 28px rgba(184,255,0,.15)}
  50%{box-shadow:0 0 24px rgba(184,255,0,.75),0 0 48px rgba(184,255,0,.35)}
}

/* ‚îÄ‚îÄ CATS ‚îÄ‚îÄ */
.cats{display:flex;gap:6px;padding:10px 10px 12px;overflow-x:auto;scrollbar-width:none;position:relative}
.cats::-webkit-scrollbar{display:none}
.cat{
  flex-shrink:0;height:32px;padding:0 14px;border-radius:20px;
  border:1px solid rgba(255,255,255,.07);
  background:transparent;
  color:rgba(255,255,255,.38);
  font-family:'Barlow Condensed',sans-serif;
  font-size:13px;font-weight:700;letter-spacing:2px;
  cursor:pointer;white-space:nowrap;
  display:flex;align-items:center;
  position:relative;overflow:hidden;
  transition:color .2s,border-color .2s,background .2s,transform .15s,box-shadow .2s;
}
.cat::after{
  content:'';position:absolute;bottom:0;left:15%;right:15%;height:1.5px;
  background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);
  border-radius:2px;opacity:0;
  transition:opacity .2s;
}
.cat:hover{color:rgba(255,255,255,.75);border-color:rgba(255,255,255,.15);background:rgba(255,255,255,.07);transform:translateY(-1px)}
.cat:hover::after{opacity:1}
.cat:active{transform:scale(.95) translateY(0)}
.cat.on{
  color:#fff;
  border-color:rgba(255,77,109,.5);
  background:linear-gradient(135deg,rgba(255,77,109,.18) 0%,rgba(255,77,109,.07) 100%);
  box-shadow:0 0 18px rgba(255,77,109,.28),inset 0 1px 0 rgba(255,255,255,.1);
  animation:catGlow 2.8s ease-in-out infinite;
}
.cat.on::after{
  left:8%;right:8%;height:2px;
  background:linear-gradient(90deg,transparent,rgba(255,77,109,.9),transparent);
  opacity:1;animation:catLine 2.8s ease-in-out infinite;
}

@keyframes catGlow{
  0%,100%{box-shadow:0 0 12px rgba(255,77,109,.2),inset 0 1px 0 rgba(255,255,255,.08)}
  50%{box-shadow:0 0 28px rgba(255,77,109,.45),0 0 55px rgba(255,77,109,.1),inset 0 1px 0 rgba(255,255,255,.15)}
}
@keyframes catLine{
  0%,100%{opacity:.65;transform:scaleX(.85)}
  50%{opacity:1;transform:scaleX(1.1)}
}
@keyframes catIcoBounce{
  0%{transform:scale(1)}
  55%{transform:scale(1.4) rotate(-10deg)}
  100%{transform:scale(1.1)}
}

/* ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ */
.content{flex:1;padding:8px 10px 90px}
.slabel{
  font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:600;
  letter-spacing:3px;color:var(--mu2);text-transform:uppercase;
  padding:8px 2px 8px;display:flex;align-items:center;justify-content:space-between;
}
.slabel span{font-family:'DM Sans',sans-serif;font-size:11px;font-weight:400;letter-spacing:0;color:var(--mu)}

/* ‚îÄ‚îÄ GRID ‚îÄ‚îÄ */
.tgrid{display:grid;grid-template-columns:1fr 1fr;gap:9px}
.tcard{
  border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.06);
  background:#111;cursor:pointer;position:relative;
  box-shadow:none;
  transition:transform .25s cubic-bezier(.2,.8,.3,1),border-color .2s,box-shadow .2s;
  animation:cin .4s cubic-bezier(.2,.8,.3,1) both;
}
.tcard:nth-child(1){animation-delay:0s}.tcard:nth-child(2){animation-delay:.06s}
.tcard:nth-child(3){animation-delay:.12s}.tcard:nth-child(4){animation-delay:.18s}
.tcard:nth-child(5){animation-delay:.24s}.tcard:nth-child(6){animation-delay:.30s}
.tcard:nth-child(n+7){animation-delay:.36s}
@keyframes cin{from{opacity:0;transform:translateY(18px) scale(.95)}to{opacity:1;transform:translateY(0) scale(1)}}
.tcard:active{transform:scale(.94) !important;border-color:rgba(184,255,0,.6) !important;box-shadow:0 0 24px rgba(184,255,0,.25) !important}
.tcard:active .tcard-media{animation-play-state:paused}
.tcard:hover{transform:translateY(-4px);border-color:rgba(184,255,0,.3);box-shadow:0 10px 28px rgba(0,0,0,.6),0 0 20px rgba(184,255,0,.1)}
.tcard:hover .tcard-media{animation-play-state:paused}
.tcard-shimmer{position:absolute;inset:0;z-index:2;pointer-events:none;overflow:hidden;border-radius:12px}
.tcard-shimmer::after{content:'';position:absolute;inset:0;background:linear-gradient(105deg,transparent 35%,rgba(184,255,0,.05) 50%,transparent 65%);background-size:250% 100%;animation:shimmer 4s ease-in-out infinite;opacity:0;transition:opacity .3s}
.tcard:hover .tcard-shimmer::after{opacity:1}
@keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
.tcard:hover{border-color:var(--yb);box-shadow:0 0 16px rgba(245,200,0,.06)}
.tcard.wide{grid-column:1/-1}
.tcard-media{
  width:100%;aspect-ratio:9/16;
  background:var(--s2);display:flex;align-items:center;justify-content:center;
  font-size:32px;position:relative;overflow:hidden;
}
/* animate ONLY img/video ‚Äî overflow:hidden clips it nicely */
.tcard-media img,.tcard-media video{
  width:108%;height:108%;object-fit:cover;position:absolute;
  top:-4%;left:-4%;
  will-change:transform;
  animation:cardFloat 9s linear infinite;
}
/* emoji wrapper ‚Äî subtle float only */
.tcard-media>.tcard-emoji{
  will-change:transform;
  animation:cardFloatEmoji 9s linear infinite;
}
/* stagger per card */
.tcard:nth-child(1) .tcard-media img,.tcard:nth-child(1) .tcard-media video,.tcard:nth-child(1) .tcard-media>.tcard-emoji{animation-delay:0s;animation-duration:8s}
.tcard:nth-child(2) .tcard-media img,.tcard:nth-child(2) .tcard-media video,.tcard:nth-child(2) .tcard-media>.tcard-emoji{animation-delay:-2.2s;animation-duration:9.5s}
.tcard:nth-child(3) .tcard-media img,.tcard:nth-child(3) .tcard-media video,.tcard:nth-child(3) .tcard-media>.tcard-emoji{animation-delay:-4.1s;animation-duration:7.5s}
.tcard:nth-child(4) .tcard-media img,.tcard:nth-child(4) .tcard-media video,.tcard:nth-child(4) .tcard-media>.tcard-emoji{animation-delay:-6.3s;animation-duration:10s}
.tcard:nth-child(5) .tcard-media img,.tcard:nth-child(5) .tcard-media video,.tcard:nth-child(5) .tcard-media>.tcard-emoji{animation-delay:-1.5s;animation-duration:8.5s}
.tcard:nth-child(6) .tcard-media img,.tcard:nth-child(6) .tcard-media video,.tcard:nth-child(6) .tcard-media>.tcard-emoji{animation-delay:-3.8s;animation-duration:9s}
.tcard:nth-child(7) .tcard-media img,.tcard:nth-child(7) .tcard-media video,.tcard:nth-child(7) .tcard-media>.tcard-emoji{animation-delay:-5.5s;animation-duration:7.8s}
.tcard:nth-child(8) .tcard-media img,.tcard:nth-child(8) .tcard-media video,.tcard:nth-child(8) .tcard-media>.tcard-emoji{animation-delay:-7.2s;animation-duration:9.2s}
.tcard:nth-child(n+9) .tcard-media img,.tcard:nth-child(n+9) .tcard-media video,.tcard:nth-child(n+9) .tcard-media>.tcard-emoji{animation-delay:-0.9s;animation-duration:8.2s}
@keyframes cardFloat{
  0%  {transform:translate(0,0)}
  25% {transform:translate(4%,3%)}
  50% {transform:translate(0,5%)}
  75% {transform:translate(-4%,2%)}
  100%{transform:translate(0,0)}
}
@keyframes cardFloatEmoji{
  0%  {transform:translate(0,0)}
  25% {transform:translate(6px,4px)}
  50% {transform:translate(0,8px)}
  75% {transform:translate(-5px,3px)}
  100%{transform:translate(0,0)}
}
/* golden corner cut */
.tcard-media::after{
  content:'';position:absolute;bottom:0;right:0;
  border-style:solid;border-width:0 0 18px 18px;
  border-color:transparent transparent rgba(245,200,0,.18) transparent;
}
/* cost-pin ‚Äî –∂—ë–ª—Ç—ã–π –∞–∫—Ü–µ–Ω—Ç */
.cost-pin{
  display:inline-flex;align-items:center;gap:4px;
  background:rgba(184,255,0,.12);
  border:1px solid rgba(184,255,0,.35);
  border-radius:6px;
  padding:2px 8px;
  font-family:'Barlow Condensed',sans-serif;
  font-size:13px;font-weight:800;color:var(--y);
  letter-spacing:.5px;flex-shrink:0;
}

/* ‚îÄ‚îÄ CARD BODY ‚îÄ‚îÄ */
.tcard-body{
  padding:8px 10px 10px;
  background:linear-gradient(180deg,rgba(255,255,255,.03) 0%,transparent 100%);
  border-top:1px solid rgba(255,255,255,.06);
}
.tcard-body::before{display:none}
.tcard-name{
  font-family:'Barlow Condensed',sans-serif;
  font-size:14px;font-weight:800;letter-spacing:.5px;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  color:#fff;
}
.tcard-meta{
  display:flex;align-items:center;justify-content:space-between;
  margin-top:7px;
}
.cat-tag{
  font-size:9px;padding:3px 8px;border-radius:20px;
  background:rgba(255,255,255,.06);
  color:rgba(255,255,255,.45);
  border:1px solid rgba(255,255,255,.09);
  font-family:'Barlow Condensed',sans-serif;font-weight:700;
  text-transform:uppercase;letter-spacing:1px;
}
.use-c{font-size:10px;color:var(--mu2);display:flex;align-items:center;gap:3px;letter-spacing:.3px}
.use-c svg{width:10px;height:10px;fill:currentColor}

/* ‚îÄ‚îÄ TAB SECTION ‚îÄ‚îÄ */
.tabsec{padding-top:8px}
.tsec-title{font-family:'Barlow Condensed',sans-serif;font-size:17px;font-weight:700;letter-spacing:1px;margin-bottom:12px;color:var(--y)}

/* ‚îÄ‚îÄ FORM ELEMENTS ‚îÄ‚îÄ */
.flabel{display:block;font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:600;letter-spacing:2px;color:var(--mu);text-transform:uppercase;margin-bottom:6px}
.frow{margin-bottom:13px}
textarea,input[type=text],input[type=number],select{
  width:100%;background:var(--s2);border:1px solid var(--bd);border-radius:var(--rsm);
  color:var(--wh);font-family:'DM Sans',sans-serif;font-size:13px;
  padding:10px 12px;outline:none;transition:border-color .18s;resize:none;-webkit-appearance:none;
}
textarea:focus,input:focus,select:focus{border-color:rgba(245,200,0,.45)}
textarea{height:70px}
select option{background:#0A0A14}

/* upload zone */
.upzone{
  width:100%;border:1.5px dashed rgba(255,255,255,.1);border-radius:var(--r);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:5px;cursor:pointer;background:var(--s1);position:relative;overflow:hidden;
  transition:border-color .18s;
}
.upzone:hover{border-color:var(--yb)}
.upzone svg{width:26px;height:26px;stroke:rgba(245,200,0,.35);fill:none;pointer-events:none}
.upzone-lbl{font-size:12px;color:var(--mu);pointer-events:none;text-align:center;line-height:1.5}
.upzone-thumb,.upzone-vid{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:none;border-radius:calc(var(--r) - 1px)}
.upzone-clr{position:absolute;top:6px;right:6px;width:22px;height:22px;border-radius:50%;background:rgba(0,0,0,.72);border:1px solid rgba(255,255,255,.15);color:rgba(255,255,255,.7);font-size:10px;display:none;align-items:center;justify-content:center;cursor:pointer;z-index:5}
.upzone.has-file .upzone-clr{display:flex}
.upzone.has-file>svg,.upzone.has-file .upzone-lbl{opacity:0;pointer-events:none}

/* ratio picker */
.ratio-row{display:flex;gap:5px;flex-wrap:wrap}
.rpill{padding:6px 11px;border-radius:5px;border:1px solid var(--bd);background:transparent;color:var(--mu);font-size:12px;font-family:'Barlow Condensed',sans-serif;font-weight:600;letter-spacing:.4px;cursor:pointer;transition:all .12s}
.rpill.on{border-color:var(--y);color:var(--y);background:var(--yd)}
.rpill.more-btn{background:var(--s2)}
.more-ratios{display:none;flex-wrap:wrap;gap:5px;width:100%;margin-top:5px}
.more-ratios.open{display:flex}



/* ‚îÄ‚îÄ SHEET (shop/other bottom sheets) ‚îÄ‚îÄ */
.overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.82);display:flex;align-items:flex-end;opacity:0;pointer-events:none;transition:opacity .25s}
.overlay.open{opacity:1;pointer-events:all}
.sheet{width:100%;background:#0f0f0f;border:1px solid rgba(255,255,255,.08);border-bottom:none;border-radius:20px 20px 0 0;transform:translateY(102%);transition:transform .3s cubic-bezier(.32,.72,0,1);max-height:93vh;overflow-y:auto;padding-bottom:28px}
.overlay.open .sheet{transform:translateY(0)}
.sheet::-webkit-scrollbar{display:none}
.s-handle{width:32px;height:3px;border-radius:2px;background:rgba(255,255,255,.12);margin:10px auto 0}
.s-title{font-family:'Barlow Condensed',sans-serif;font-size:20px;font-weight:700;letter-spacing:1.2px}
.s-sub{font-size:12px;color:var(--mu);margin-top:2px;line-height:1.4}
.s-body{padding:13px 16px}
.s-footer{padding:10px 16px 0;display:flex;gap:7px}

/* ‚îÄ‚îÄ TEMPLATE FULLSCREEN ‚îÄ‚îÄ */
#tmplOvl{
  position:fixed;inset:0;z-index:200;
  background:#070707;
  opacity:0;pointer-events:none;
  transform:translateY(100%);
  transition:opacity .25s, transform .3s cubic-bezier(.32,.72,0,1);
  display:flex;flex-direction:column;
}
#tmplOvl.open{opacity:1;pointer-events:all;transform:translateY(0)}
#tmplOvl .sheet{
  width:100%;height:100%;
  border-radius:0;border:none;
  transform:none !important;
  max-height:none;
  display:flex;flex-direction:column;
  background:#070707;
  padding-bottom:0;
  overflow:hidden;
}
/* sticky top bar */
.tmpl-topbar{
  position:sticky;top:0;z-index:10;
  display:flex;align-items:center;gap:12px;
  padding:10px 14px;
  background:rgba(7,7,7,.95);
  backdrop-filter:blur(20px);
  border-bottom:1px solid rgba(255,255,255,.07);
  flex-shrink:0;
}
/* back button */
.s-back-btn{
  display:flex;align-items:center;gap:0;
  height:34px;
  background:rgba(255,255,255,.06);
  border:1px solid rgba(255,255,255,.1);
  border-radius:20px;
  padding:0 14px 0 10px;
  cursor:pointer;
  color:rgba(255,255,255,.75);
  font-family:'Barlow Condensed',sans-serif;
  font-size:14px;font-weight:700;letter-spacing:.8px;
  transition:background .15s, border-color .15s, color .15s;
  flex-shrink:0;
}
.s-back-btn:hover{background:rgba(255,255,255,.1);border-color:rgba(255,255,255,.22);color:#fff}
.s-back-btn:active{transform:scale(.94)}
.s-back-btn svg{width:18px;height:18px;stroke:currentColor;fill:none;margin-right:4px}
.s-title-block{flex:1;min-width:0}
.s-hdr{display:none}
.s-hdr-with-back{display:none}
/* scrollable content */
#tmplOvl .sheet-scroll{flex:1;overflow-y:auto;padding-bottom:0}
#tmplOvl .sheet-scroll::-webkit-scrollbar{display:none}
/* sticky footer */
.tmpl-footer{
  padding:10px 14px 28px;
  background:rgba(7,7,7,.95);
  backdrop-filter:blur(20px);
  border-top:1px solid rgba(255,255,255,.07);
  display:flex;gap:8px;
  flex-shrink:0;
}
.btn-y{flex:1;height:44px;border-radius:10px;border:none;background:var(--y);color:#000;font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;letter-spacing:1.2px;cursor:pointer;position:relative;overflow:hidden;transition:opacity .14s;display:flex;align-items:center;justify-content:center;gap:6px}
.btn-y::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,.15),transparent 55%)}
.btn-y:active{opacity:.86}
.btn-ghost{flex:1;height:44px;border-radius:10px;border:1px solid var(--bd);background:transparent;color:var(--mu);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;cursor:pointer;transition:border-color .15s,color .15s}
.btn-ghost:hover{border-color:var(--bd2);color:var(--wh)}

/* template sheet banner */
.s-banner{width:100%;border-radius:var(--r);overflow:hidden;margin-bottom:12px;position:relative;background:var(--s2)}
.s-banner-916{background:linear-gradient(135deg,#0d0d0d,#111);position:relative;}
.s-banner-916::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 20% 50%,rgba(184,255,0,.07),transparent 60%),radial-gradient(ellipse at 80% 50%,rgba(255,77,109,.07),transparent 60%)}
/* animated upload slots */
.mz-slot-glow{position:relative;overflow:hidden;}
.mz-slot-glow::before{
  content:'';position:absolute;inset:0;
  background:radial-gradient(ellipse at 50% 30%,rgba(184,255,0,.06),transparent 70%);
  animation:slotPulse 3s ease-in-out infinite;
}
.mz-slot-glow::after{
  content:'';position:absolute;bottom:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,rgba(184,255,0,.25),transparent);
  animation:slotLine 3s ease-in-out infinite;
}
@keyframes slotPulse{0%,100%{opacity:.5}50%{opacity:1}}
@keyframes slotLine{0%,100%{opacity:.3;transform:scaleX(.6)}50%{opacity:.8;transform:scaleX(1)}}
.s-banner-media{width:100%;display:flex;align-items:center;justify-content:center;font-size:44px;position:relative;overflow:hidden;background:#0a0a0a}
.s-banner-media img,.s-banner-media video{width:100%;height:100%;object-fit:contain;display:block}
.s-banner-916 .s-banner-media img,
.s-banner-916 .s-banner-media video{object-fit:cover}
.s-banner-cost{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.65);backdrop-filter:blur(6px);border:1px solid var(--yb);border-radius:4px;padding:2px 8px;font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;color:var(--y)}
.s-banner-uses{position:absolute;bottom:8px;left:8px;background:rgba(0,0,0,.65);backdrop-filter:blur(6px);border-radius:4px;padding:2px 8px;font-size:11px;color:var(--mu);display:flex;align-items:center;gap:4px}

/* ‚îÄ‚îÄ SHOP ‚îÄ‚îÄ */
.plan{background:var(--s1);border:1px solid var(--bd);border-radius:var(--r);padding:12px 14px;cursor:pointer;display:flex;justify-content:space-between;align-items:center;margin-bottom:7px;transition:border-color .15s,background .15s}
.plan:hover{border-color:var(--yb);background:var(--yd)}
.plan.feat{border-color:var(--yb)}
.plan-name{font-family:'Barlow Condensed',sans-serif;font-size:15px;font-weight:700;letter-spacing:.8px}
.plan-sub{font-size:11px;color:var(--mu);margin-top:1px}
.plan-price{font-family:'Barlow Condensed',sans-serif;font-size:24px;font-weight:700;color:var(--y)}
.plan-hit{font-size:9px;font-weight:700;background:var(--y);color:#000;padding:1px 6px;border-radius:3px;font-family:'Barlow Condensed',sans-serif;letter-spacing:.8px;margin-left:6px;vertical-align:middle}

/* ‚îÄ‚îÄ "–ï–©–Å" MENU ‚îÄ‚îÄ */
.etc-grid{display:flex;flex-direction:column;gap:8px;padding-top:4px}
.etc-item{display:flex;align-items:center;gap:12px;background:var(--s1);border:1px solid var(--bd);border-radius:var(--r);padding:13px 15px;cursor:pointer;transition:border-color .15s,background .15s}
.etc-item:hover{border-color:var(--bd2);background:var(--s2)}
.etc-ico{width:36px;height:36px;border-radius:8px;background:var(--s2);border:1px solid var(--bd);display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0}
.etc-info{flex:1}
.etc-title{font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;letter-spacing:.5px}
.etc-sub{font-size:11px;color:var(--mu);margin-top:1px}
.etc-arr{color:var(--mu);font-size:14px;flex-shrink:0}

/* ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ */
#adminPanel{position:fixed;inset:0;z-index:400;background:var(--bg);display:none;flex-direction:column}
#adminPanel.open{display:flex}
.adm-hdr{
  padding:14px 16px;
  border-bottom:1px solid rgba(255,255,255,.06);
  background:rgba(255,255,255,.02);
  display:flex;align-items:center;justify-content:space-between;
}
.adm-title{
  font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:900;
  letter-spacing:4px;color:var(--y);
  text-shadow:0 0 20px rgba(184,255,0,.3);
}
.adm-close{
  width:32px;height:32px;border-radius:8px;
  border:1px solid rgba(255,255,255,.08);background:transparent;
  color:rgba(255,255,255,.4);font-size:16px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;transition:all .15s;
  font-family:'Barlow Condensed',sans-serif;font-weight:700;
}
.adm-close:hover{border-color:var(--red);color:var(--red);background:rgba(255,77,109,.08)}
.adm-body{flex:1;overflow-y:auto;padding:16px 14px 110px}
.adm-btm{position:fixed;bottom:0;left:0;right:0;background:rgba(5,5,5,.96);backdrop-filter:blur(24px);border-top:1px solid rgba(255,255,255,.06);padding:10px 14px 22px}
.adm-sec{
  font-family:'Barlow Condensed',sans-serif;font-size:10px;font-weight:700;
  letter-spacing:4px;color:rgba(255,255,255,.25);text-transform:uppercase;
  padding:18px 0 10px;display:flex;align-items:center;gap:10px;
}
.adm-sec::after{content:'';flex:1;height:1px;background:rgba(255,255,255,.05)}
/* stats */
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:4px}
.stat-box{
  background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.06);
  border-radius:12px;padding:14px;
}
.stat-n{font-family:'Barlow Condensed',sans-serif;font-size:32px;font-weight:900;color:var(--y);line-height:1;text-shadow:0 0 20px rgba(184,255,0,.25)}
.stat-l{font-size:9px;color:rgba(255,255,255,.3);margin-top:4px;letter-spacing:2px;font-family:'Barlow Condensed',sans-serif;font-weight:700;text-transform:uppercase}
/* add form */
.add-form{
  background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.06);
  border-radius:12px;padding:15px;margin-bottom:8px;
}
.add-form-hdr{
  font-family:'Barlow Condensed',sans-serif;font-size:13px;font-weight:900;
  letter-spacing:3px;color:rgba(255,255,255,.5);margin-bottom:13px;
  text-transform:uppercase;
}
/* template types - 4 options */
.ttype-row{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:6px;margin-bottom:11px}
.ttype-opt{
  border:1px solid rgba(255,255,255,.07);border-radius:8px;padding:12px 6px;
  cursor:pointer;transition:all .16s;text-align:center;background:rgba(255,255,255,.02);
}
.ttype-opt:hover{border-color:rgba(184,255,0,.2);background:rgba(184,255,0,.04)}
.ttype-opt.on{border-color:var(--yb);background:var(--yd);box-shadow:0 0 14px rgba(184,255,0,.15)}
.ttype-opt .tto-n{
  font-family:'Barlow Condensed',sans-serif;font-size:26px;font-weight:900;
  color:rgba(255,255,255,.2);line-height:1;margin-bottom:3px;transition:color .16s;
}
.ttype-opt.on .tto-n{color:var(--y);text-shadow:0 0 12px rgba(184,255,0,.5)}
.ttype-opt .tto-lbl{font-family:'Barlow Condensed',sans-serif;font-size:9px;font-weight:700;letter-spacing:1.5px;color:rgba(255,255,255,.25);transition:color .16s}
.ttype-opt.on .tto-lbl{color:rgba(184,255,0,.7)}
/* preview zone */
.prev-zone{width:100%;aspect-ratio:16/6;border:1.5px dashed rgba(255,255,255,.1);border-radius:var(--rsm);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;cursor:pointer;background:var(--s2);position:relative;overflow:hidden;margin-bottom:11px;transition:border-color .18s}
.prev-zone:hover{border-color:var(--yb)}
#prevImg,#prevVid{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:none}
/* media toggle */
.mtoggle{display:flex;gap:5px;margin-bottom:9px}
.mtype{flex:1;height:32px;border-radius:6px;border:1px solid var(--bd);background:transparent;color:var(--mu);font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:600;letter-spacing:.5px;cursor:pointer;transition:all .14s;display:flex;align-items:center;justify-content:center;gap:4px}
.mtype svg{width:12px;height:12px;fill:currentColor}
.mtype.on{border-color:var(--blb);background:var(--bld);color:var(--bl)}
/* admin list */
.adm-list{display:flex;flex-direction:column;gap:6px}
.adm-item{
  background:rgba(255,255,255,.02);border:1px solid rgba(255,255,255,.06);
  border-radius:10px;padding:10px 12px;display:flex;align-items:center;gap:10px;
  transition:border-color .15s;
}
.adm-item:hover{border-color:rgba(255,255,255,.1)}
.adm-thumb{width:40px;height:40px;border-radius:8px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;overflow:hidden}
.adm-thumb img,.adm-thumb video{width:100%;height:100%;object-fit:cover}
.adm-info{flex:1;min-width:0}
.adm-name{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:rgba(255,255,255,.85)}
.adm-meta{font-size:10px;color:rgba(255,255,255,.3);margin-top:2px;letter-spacing:.3px}
.adm-actions{display:flex;align-items:center;gap:5px;flex-shrink:0}
.adm-edit-btn{width:28px;height:28px;border-radius:6px;border:1px solid rgba(255,255,255,.08);background:transparent;color:rgba(255,255,255,.35);font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .14s;font-family:'Barlow Condensed',sans-serif;font-weight:700;letter-spacing:.5px}
.adm-edit-btn:hover{border-color:var(--y);color:var(--y)}
.toggle{width:34px;height:18px;border-radius:9px;background:var(--s2);border:1px solid var(--bd);position:relative;cursor:pointer;transition:all .15s;flex-shrink:0}
.toggle.on{background:rgba(90,200,138,.18);border-color:var(--gr)}
.toggle::after{content:'';position:absolute;top:2px;left:2px;width:12px;height:12px;border-radius:50%;background:var(--mu);transition:transform .15s,background .15s}
.toggle.on::after{transform:translateX(16px);background:var(--gr)}
.adm-edit-btn{height:26px;padding:0 9px;border-radius:5px;border:1px solid rgba(184,255,0,.3);background:rgba(184,255,0,.06);color:var(--y);font-family:'Barlow Condensed',sans-serif;font-size:11px;font-weight:700;letter-spacing:.5px;cursor:pointer;display:flex;align-items:center;transition:all .14s}
.adm-edit-btn:hover{background:rgba(184,255,0,.15);border-color:var(--y)}
.del-btn{width:26px;height:26px;border-radius:5px;border:1px solid var(--bd);background:transparent;color:var(--mu);font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .14s}
.del-btn:hover{border-color:var(--red);color:var(--red)}
/* cat manage */
.cat-adm-list{display:flex;flex-wrap:wrap;gap:5px;margin-bottom:4px}
.cat-adm-chip{display:flex;align-items:center;gap:4px;background:var(--s2);border:1px solid var(--bd);border-radius:5px;padding:3px 9px;font-size:11px;font-weight:600;color:var(--bl)}
.cat-adm-chip .cac-del{cursor:pointer;color:var(--mu);font-size:11px;margin-left:2px;transition:color .12s}
.cat-adm-chip .cac-del:hover{color:var(--red)}
/* emoji picker */
.emoji-picker{display:flex;flex-wrap:wrap;gap:5px;background:var(--s2);border:1px solid var(--bd);border-radius:var(--rsm);padding:8px;margin-top:6px;display:none}
.emoji-picker.open{display:flex}
.ep-emoji{font-size:18px;cursor:pointer;padding:3px;border-radius:5px;transition:background .12s}
.ep-emoji:hover{background:var(--s3)}
.ep-emoji.sel{background:var(--yd);outline:1px solid var(--yb)}
.cat-form-row{display:flex;gap:6px;align-items:flex-start}
.cat-form-row input{flex:1}
.emoji-preview{width:38px;height:38px;border-radius:6px;border:1px solid var(--bd);background:var(--s2);display:flex;align-items:center;justify-content:center;font-size:18px;cursor:pointer;flex-shrink:0;transition:border-color .15s}
.emoji-preview:hover{border-color:var(--yb)}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast{position:fixed;top:58px;left:50%;transform:translateX(-50%) translateY(-4px);background:rgba(9,9,15,.96);border:1px solid var(--bd);border-radius:7px;padding:7px 14px;font-size:12px;font-weight:500;z-index:999;opacity:0;transition:all .22s;pointer-events:none;white-space:nowrap}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.toast.ok{border-color:rgba(90,200,138,.4);color:var(--gr)}
.toast.err{border-color:rgba(212,90,90,.4);color:var(--red)}

/* ‚îÄ‚îÄ EMPTY ‚îÄ‚îÄ */
.empty{grid-column:1/-1;text-align:center;padding:44px 0;color:var(--mu);font-size:13px}
.empty .ei{font-size:34px;margin-bottom:10px}

/* ‚îÄ‚îÄ MULTI ZONE ‚îÄ‚îÄ */
.multi-zone{display:grid;grid-template-columns:1fr 1fr;gap:0;border-radius:var(--r);overflow:hidden;border:1.5px solid rgba(255,255,255,.08);}
.mz-slot{
  height:150px;border-radius:0;border:none;
  border-right:1px solid rgba(255,255,255,.06);
  background:var(--s1);display:flex;flex-direction:column;align-items:center;
  justify-content:center;gap:6px;cursor:pointer;position:relative;overflow:hidden;
  transition:background .18s;
}
.mz-slot:nth-child(even){border-right:none;}
.mz-slot:nth-child(n+3){border-top:1px solid rgba(255,255,255,.06);}
.mz-slot:hover:not(.locked){border-color:var(--yb);background:var(--yd)}
.mz-slot.locked{cursor:default;opacity:.4}
.mz-slot span{font-size:11px;color:var(--mu);font-weight:500;pointer-events:none}
.mz-slot .mz-img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;border-radius:calc(var(--r) - 1px)}
.mz-slot .mz-del{position:absolute;top:5px;right:5px;width:20px;height:20px;border-radius:50%;background:rgba(0,0,0,.75);border:1px solid rgba(255,255,255,.15);color:rgba(255,255,255,.8);font-size:9px;display:none;align-items:center;justify-content:center;cursor:pointer;z-index:5}
.mz-slot.has-img .mz-del{display:flex}
.mz-slot.has-img svg,.mz-slot.has-img span{opacity:0}
.mz-slot .mz-num{position:absolute;bottom:5px;left:7px;font-size:9px;color:rgba(255,255,255,.4);font-family:'Barlow Condensed',sans-serif;font-weight:600}

/* ‚îÄ‚îÄ CONFIRM MODAL ‚îÄ‚îÄ */
.confirm-modal{position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s;padding:20px}
.confirm-modal.open{opacity:1;pointer-events:all}
.confirm-box{background:#0D0D18;border:1px solid var(--bd2);border-radius:16px;padding:22px 20px;width:100%;max-width:320px;text-align:center}
.confirm-ico{font-size:32px;margin-bottom:10px}
.confirm-title{font-family:'Barlow Condensed',sans-serif;font-size:18px;font-weight:700;letter-spacing:1px;margin-bottom:6px}
.confirm-sub{font-size:12px;color:var(--mu);line-height:1.5;margin-bottom:18px}
.confirm-btns{display:flex;gap:8px}
.confirm-btns .btn-danger{flex:1;height:44px;border-radius:9px;border:none;background:var(--red);color:#fff;font-family:'Barlow Condensed',sans-serif;font-size:14px;font-weight:700;letter-spacing:1px;cursor:pointer;transition:opacity .15s}
.confirm-btns .btn-danger:active{opacity:.8}

/* ‚îÄ‚îÄ EDIT TEMPLATE SHEET ‚îÄ‚îÄ */
#editTplSheet{position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.85);display:flex;align-items:flex-end;opacity:0;pointer-events:none;transition:opacity .25s}
#editTplSheet.open{opacity:1;pointer-events:all}
#editTplSheet .sheet{max-height:95vh}

/* ‚îÄ‚îÄ HELPER ‚îÄ‚îÄ */
.hint{font-size:12px;color:var(--mu);margin-top:5px;line-height:1.5}
</style>
</head>
<body>
<canvas id="bgc"></canvas>
<div class="toast" id="toast"></div>

<div class="app">

<!-- –ø–æ–¥–ø–∏—Å—å –Ω–∞–¥ –Ω–∏–∂–Ω–µ–π –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π -->
<div class="app-signature"><span>Nano Banano</span> ¬∑ AI –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</div>

<!-- HEADER -->
<header class="hdr">
  <div class="logo">
    <span class="logo-mark">N</span><span class="logo-dot">¬∑</span><span class="logo-mark2">BANANO</span>
  </div>
  <div class="hdr-r">
    <div class="gen-wrap">
      <div class="gen-count">‚ö° <span id="genCount">5</span></div>
      <button class="gen-buy" onclick="openShop()">–ö–£–ü–ò–¢–¨</button>
    </div>
    <!-- admin btn: hidden by default, shown via checkAdmin() -->
    <div class="ic-btn hidden" id="adminBtn" onclick="openAdmin()">
      <svg viewBox="0 0 24 24" stroke-width="1.8"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
    </div>
  </div>
</header>

<!-- MAIN NAV -->
<nav class="mainnav" id="mainnav">
  <div class="nav-indicator" id="navIndicator"></div>
  <button class="navbtn on" id="nav-templates" onclick="switchNav('templates')" title="–®–∞–±–ª–æ–Ω—ã">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>
    <span class="nav-lbl">–®–∞–±–ª–æ–Ω—ã</span>
  </button>
  <button class="navbtn" id="nav-edit" onclick="switchNav('edit')" title="–ò–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
    <span class="nav-lbl">–ò–∑–º–µ–Ω–∏—Ç—å</span>
  </button>
  <!-- –°–û–ó–î–ê–¢–¨ ‚Äî —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ -->
  <button class="navbtn navbtn-create" id="nav-create" onclick="switchNav('create')" title="–°–æ–∑–¥–∞—Ç—å">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    <span class="nav-lbl">–°–æ–∑–¥–∞—Ç—å</span>
  </button>
  <button class="navbtn" id="nav-upscale" onclick="switchNav('upscale')" title="–£–ª—É—á—à–∏—Ç—å">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
    <span class="nav-lbl">–£–ª—É—á—à–∏—Ç—å</span>
  </button>
  <button class="navbtn" id="nav-history" onclick="switchNav('history')" title="–ú–æ–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
    <span class="nav-lbl">–ú–æ–∏</span>
  </button>
</nav>

<!-- CONTENT -->
<div class="content">

  <!-- ‚îÄ‚îÄ TEMPLATES ‚îÄ‚îÄ -->
  <div id="tab-templates">
    <div class="cats" id="catsBar"></div>
    <div class="slabel">–ü–û–ü–£–õ–Ø–†–ù–´–ï</div>
    <div class="tgrid" id="tgrid"></div>
  </div>

  <!-- ‚îÄ‚îÄ CREATE ‚îÄ‚îÄ -->
  <div id="tab-create" style="display:none">
    <div class="tabsec">
      <div class="frow">
        <label class="flabel">–ü–†–û–ú–ü–¢</label>
        <textarea id="createPrompt" placeholder="–û–ø–∏—à–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: —Å—Ç–∏–ª—å, –¥–µ—Ç–∞–ª–∏, –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ..."></textarea>
      </div>
      <div class="frow">
        <label class="flabel">–°–û–û–¢–ù–û–®–ï–ù–ò–ï –°–¢–û–†–û–ù</label>
        <div id="ratioCreate"></div>
      </div>
      <button class="btn-y" style="width:100%" onclick="doCreate()">‚ö° –°–ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨</button>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ EDIT ‚îÄ‚îÄ -->
  <div id="tab-edit" style="display:none">
    <div class="tabsec">
      <div class="frow">
        <label class="flabel">–§–û–¢–û –î–õ–Ø –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø <span style="color:var(--mu);font-weight:400;letter-spacing:0;text-transform:none;font-size:10px">(–¥–æ 4 —Ñ–æ—Ç–æ)</span></label>
        <!-- multi photo grid -->
        <div class="multi-zone" id="editMultiZone">
          <div class="mz-slot" id="mzs-0" onclick="triggerMultiFile(0)">
            <svg viewBox="0 0 24 24" width="22" height="22" stroke="rgba(245,200,0,.35)" fill="none"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
            <span>–§–æ—Ç–æ 1</span>
            <input type="file" id="mzf-0" accept="image/*,video/*" style="display:none" onchange="addMultiPhoto(this,0)">
          </div>
          <div class="mz-slot locked" id="mzs-1" onclick="triggerMultiFile(1)">
            <svg viewBox="0 0 24 24" width="22" height="22" stroke="rgba(90,88,96,.5)" fill="none"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
            <span>–§–æ—Ç–æ 2</span>
            <input type="file" id="mzf-1" accept="image/*,video/*" style="display:none" onchange="addMultiPhoto(this,1)">
          </div>
          <div class="mz-slot locked" id="mzs-2" onclick="triggerMultiFile(2)">
            <svg viewBox="0 0 24 24" width="22" height="22" stroke="rgba(90,88,96,.5)" fill="none"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
            <span>–§–æ—Ç–æ 3</span>
            <input type="file" id="mzf-2" accept="image/*,video/*" style="display:none" onchange="addMultiPhoto(this,2)">
          </div>
          <div class="mz-slot locked" id="mzs-3" onclick="triggerMultiFile(3)">
            <svg viewBox="0 0 24 24" width="22" height="22" stroke="rgba(90,88,96,.5)" fill="none"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>
            <span>–§–æ—Ç–æ 4</span>
            <input type="file" id="mzf-3" accept="image/*,video/*" style="display:none" onchange="addMultiPhoto(this,3)">
          </div>
        </div>
        <div class="hint" style="margin-top:6px">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–¥–Ω–æ –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ñ–æ—Ç–æ (–¥–æ 4). –°–ª–µ–¥—É—é—â–∏–π —Å–ª–æ—Ç —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ</div>
      </div>
      <div class="frow">
        <label class="flabel">–ò–ù–°–¢–†–£–ö–¶–ò–Ø</label>
        <textarea id="editPrompt" placeholder="–ß—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å? –ù–∞–ø—Ä–∏–º–µ—Ä: –∑–∞–º–µ–Ω–∏ —Ñ–æ–Ω –Ω–∞ –º–æ—Ä–µ, –∏–∑–º–µ–Ω–∏ –ø—Ä–∏—á—ë—Å–∫—É –Ω–∞ —Ä—ã–∂—É—é..."></textarea>
      </div>
      <div class="frow">
        <label class="flabel">–°–û–û–¢–ù–û–®–ï–ù–ò–ï –°–¢–û–†–û–ù</label>
        <div id="ratioEdit"></div>
      </div>
      <button class="btn-y" style="width:100%" onclick="doEdit()">‚ö° –ò–ó–ú–ï–ù–ò–¢–¨</button>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ UPSCALE ‚îÄ‚îÄ -->
  <div id="tab-upscale" style="display:none">
    <div class="tabsec">
      <div class="frow">
        <label class="flabel">–ó–ê–ì–†–£–ó–ò–¢–ï –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ï</label>
        <div class="upzone" style="height:160px" id="upZone">
          <svg viewBox="0 0 24 24"><polyline points="15 3 21 3 21 9"/><polyline points="9 21 3 21 3 15"/><line x1="21" y1="3" x2="14" y2="10"/><line x1="3" y1="21" x2="10" y2="14"/></svg>
          <div class="upzone-lbl">–§–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞</div>
          <input type="file" accept="image/*,video/*" style="position:absolute;inset:0;opacity:0;cursor:pointer" onchange="handleZone(this,'upZone')">
          <img class="upzone-thumb" id="upThumb"><video class="upzone-vid" id="upVid" muted loop playsinline autoplay></video>
          <div class="upzone-clr" onclick="clearZone('upZone','upThumb','upVid',event)">‚úï</div>
        </div>
      </div>
      <div class="frow">
        <label class="flabel">–ú–ê–°–®–¢–ê–ë</label>
        <div class="ratio-row">
          <button class="rpill on" onclick="setUpscale(this,'1K',1)">1K ¬∑ 1‚ö°</button>
          <button class="rpill" onclick="setUpscale(this,'2K',2)">2K ¬∑ 2‚ö°</button>
          <button class="rpill" onclick="setUpscale(this,'4K',4)">4K ¬∑ 4‚ö°</button>
          <button class="rpill" onclick="setUpscale(this,'8K',6)">8K ¬∑ 6‚ö°</button>
        </div>
      </div>
      <button class="btn-y" style="width:100%" id="upscaleBtn" onclick="doUpscale()">‚ö° –ê–ü–°–ö–ï–ô–õ 1K ¬∑ 1 –≥–µ–Ω.</button>
    </div>
  </div>


  <!-- ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ -->
  <div id="tab-history" style="display:none">
    <div class="tabsec">
      <!-- –ø–ª–∞—à–∫–∞ –ø—Ä–æ 7 –¥–Ω–µ–π -->
      <div style="display:flex;align-items:center;gap:8px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px;padding:10px 14px;margin-bottom:14px">
        <div style="font-size:16px;flex-shrink:0">‚è≥</div>
        <div>
          <div style="font-family:'Barlow Condensed',sans-serif;font-size:12px;font-weight:700;letter-spacing:1.5px;color:rgba(255,255,255,.5)">–•–†–ê–ù–ï–ù–ò–ï 7 –î–ù–ï–ô</div>
          <div style="font-size:11px;color:var(--mu2);margin-top:1px">–ì–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—é—Ç—Å—è —á–µ—Ä–µ–∑ 7 –¥–Ω–µ–π</div>
        </div>
      </div>
      <div id="history-empty" style="text-align:center;padding:40px 20px 20px">
        <div style="font-size:48px;margin-bottom:12px;opacity:.3">üñº</div>
        <div style="font-family:'Barlow Condensed',sans-serif;font-size:16px;font-weight:700;letter-spacing:2px;color:rgba(255,255,255,.25)">–ü–û–ö–ê –ü–£–°–¢–û</div>
        <div style="font-size:12px;color:var(--mu2);margin-top:6px">–í–∞—à–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</div>
      </div>
      <div class="tgrid" id="history-grid"></div>
    </div>
  </div>

</div><!-- /content -->

<!-- ‚ïê‚ïê‚ïê‚ïê TEMPLATE FULLSCREEN ‚ïê‚ïê‚ïê‚ïê -->
<div id="tmplOvl">
  <div class="sheet">
    <canvas id="sheetCanvas" style="position:absolute;inset:0;width:100%;height:100%;pointer-events:none;z-index:0;opacity:.4"></canvas>
    <div style="position:relative;z-index:1;display:flex;flex-direction:column;height:100%">
      <!-- sticky top bar -->
      <div class="tmpl-topbar">
        <button type="button" class="s-back-btn" onclick="closeOverlay('tmplOvl')">
          <svg viewBox="0 0 24 24" stroke-width="2.5"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
          –ù–ê–ó–ê–î
        </button>
        <div class="s-title-block">
          <div class="s-title" id="st-title" style="font-size:17px;letter-spacing:.8px"></div>
          <div class="s-sub" id="st-sub"></div>
        </div>
      </div>
      <!-- scrollable body -->
      <div class="sheet-scroll">
        <div class="s-body" id="st-body"></div>
      </div>
      <!-- sticky footer -->
      <div class="tmpl-footer">
        <button class="btn-y" id="st-genbtn" onclick="doGenerate()" style="flex:1">
          <span>‚ö°</span><span id="st-genlabel">–°–û–ó–î–ê–¢–¨ ¬∑ 1 –≥–µ–Ω.</span>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê SHOP SHEET ‚ïê‚ïê‚ïê‚ïê -->
<div class="overlay" id="shopOvl" onclick="ovlClose(event,'shopOvl')">
  <div class="sheet">
    <div class="s-handle"></div>
    <div class="s-hdr"><div class="s-title">–ú–ê–ì–ê–ó–ò–ù</div><div class="s-sub">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞—Ä–∏—Ñ</div></div>
    <div class="s-body">
      <div class="plan" onclick="buyPlan('–ú–ò–ù–ò')">
        <div><div class="plan-name">–ú–ò–ù–ò</div><div class="plan-sub">5 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</div></div>
        <div class="plan-price">149‚ÇΩ</div>
      </div>
      <div class="plan" onclick="buyPlan('STARTER')">
        <div><div class="plan-name">STARTER</div><div class="plan-sub">10 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</div></div>
        <div class="plan-price">249‚ÇΩ</div>
      </div>
      <div class="plan feat" onclick="buyPlan('PRO')">
        <div><div class="plan-name">PRO <span class="plan-hit">–•–ò–¢</span></div><div class="plan-sub">30 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</div></div>
        <div class="plan-price">599‚ÇΩ</div>
      </div>
      <div class="plan" onclick="buyPlan('UNLIMITED')">
        <div><div class="plan-name">UNLIMITED</div><div class="plan-sub">90 –≥–µ–Ω–µ—Ä–∞—Ü–∏–π</div></div>
        <div class="plan-price">1490‚ÇΩ</div>
      </div>
      <div style="text-align:center;font-size:10px;color:var(--mu);margin-top:10px">–û–ø–ª–∞—Ç–∞ –∫–∞—Ä—Ç–æ–π (YooKassa) –∏–ª–∏ Telegram Stars</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê ADMIN PANEL ‚ïê‚ïê‚ïê‚ïê -->
<div id="adminPanel">
  <div class="adm-hdr">
    <div class="adm-title">‚öô ADMIN</div>
    <button class="adm-close" onclick="closeAdmin()">‚úï</button>
  </div>
  <div class="adm-body">

    <div class="adm-sec">–°–¢–ê–¢–ò–°–¢–ò–ö–ê</div>
    <div class="stats-grid">
      <div class="stat-box"><div class="stat-n" id="stat-t">0</div><div class="stat-l">–®–ê–ë–õ–û–ù–û–í</div></div>
      <div class="stat-box"><div class="stat-n" id="stat-a">0</div><div class="stat-l">–ê–ö–¢–ò–í–ù–´–•</div></div>
    </div>

    <!-- CATEGORIES -->
    <div class="adm-sec">–ö–ê–¢–ï–ì–û–†–ò–ò</div>
    <div class="add-form">
      <div class="add-form-hdr">–î–û–ë–ê–í–ò–¢–¨ –ö–ê–¢–ï–ì–û–†–ò–Æ</div>
      <div class="cat-form-row">
        <input type="text" id="newCatLabel" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä: –ú–∞–∫–∏—è–∂">
        <button class="rpill on" style="height:38px;padding:0 13px;flex-shrink:0" onclick="addCategory()">+</button>
      </div>
    </div>
    <div class="cat-adm-list" id="catAdmList"></div>

    <!-- ADD TEMPLATE -->
    <div class="adm-sec">–î–û–ë–ê–í–ò–¢–¨ –®–ê–ë–õ–û–ù</div>
    <div class="add-form">
      <div class="add-form-hdr">–ù–û–í–´–ô –®–ê–ë–õ–û–ù</div>

      <!-- type: 1-4 photos -->
      <div style="margin-bottom:11px">
        <label class="flabel">–ö–û–õ–ò–ß–ï–°–¢–í–û –§–û–¢ –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø</label>
        <div class="ttype-row">
          <div class="ttype-opt on" data-type="single" onclick="selTtype(this,'single')">
            <div class="tto-n">1</div>
            <div class="tto-lbl">–§–û–¢–û</div>
          </div>
          <div class="ttype-opt" data-type="double" onclick="selTtype(this,'double')">
            <div class="tto-n">2</div>
            <div class="tto-lbl">–§–û–¢–û</div>
          </div>
          <div class="ttype-opt" data-type="triple" onclick="selTtype(this,'triple')">
            <div class="tto-n">3</div>
            <div class="tto-lbl">–§–û–¢–û</div>
          </div>
          <div class="ttype-opt" data-type="quad" onclick="selTtype(this,'quad')">
            <div class="tto-n">4</div>
            <div class="tto-lbl">–§–û–¢–û</div>
          </div>
        </div>
      </div>

      <!-- preview -->
      <div class="frow">
        <label class="flabel">–ü–†–ï–í–¨–Æ –®–ê–ë–õ–û–ù–ê (—Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ)</label>
        <div class="mtoggle">
          <button class="mtype on" id="admTypeImg" onclick="setAdmMedia('image')"><svg viewBox="0 0 16 16"><rect x="1" y="2" width="14" height="12" rx="2"/><circle cx="8" cy="8" r="2.5"/></svg>–§–û–¢–û</button>
          <button class="mtype" id="admTypeVid" onclick="setAdmMedia('video')"><svg viewBox="0 0 16 16"><polygon points="6,4 6,12 12,8"/></svg>–í–ò–î–ï–û</button>
        </div>
        <div class="prev-zone" onclick="document.getElementById('admFile').click()">
          <div style="font-size:22px;opacity:.4">üñº</div>
          <div style="font-size:11px;color:var(--mu)">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–≤—å—é</div>
          <input type="file" id="admFile" accept="image/*,video/*" style="display:none" onchange="handleAdmPreview(this)">
          <img id="prevImg" alt=""><video id="prevVid" muted loop playsinline></video>
        </div>
      </div>

      <div class="frow"><label class="flabel">–ù–ê–ó–í–ê–ù–ò–ï</label><input type="text" id="nName" placeholder="–°–º–µ–Ω–∞ –ø—Ä–∏—á—ë—Å–∫–∏"></div>
      <div class="frow"><label class="flabel">–û–ü–ò–°–ê–ù–ò–ï</label><input type="text" id="nDesc" placeholder="–ü–æ–ø—Ä–æ–±—É–π –Ω–æ–≤—ã–π —Å—Ç–∏–ª—å –ø—Ä–∏—á–µ—Å–∫–∏"></div>

      <div class="frow">
        <label class="flabel">–¢–ï–ö–°–¢ –ó–û–ù–´ –ó–ê–ì–†–£–ó–ö–ò 1</label>
        <input type="text" id="nLbl1" placeholder="–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à–µ —Ñ–æ—Ç–æ">
        <div class="hint">–≠—Ç–æ –ø–æ–¥—Å–∫–∞–∑–∫–∞ –∫–æ—Ç–æ—Ä—É—é –≤–∏–¥–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –∑–æ–Ω–µ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–µ—Ä–≤–æ–≥–æ —Ñ–æ—Ç–æ</div>
      </div>
      <div class="frow" id="lbl2row" style="display:none">
        <label class="flabel">–¢–ï–ö–°–¢ –ó–û–ù–´ 2</label>
        <input type="text" id="nLbl2" placeholder="–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤—Ç–æ—Ä–æ–µ —Ñ–æ—Ç–æ">
      </div>
      <div class="frow" id="lbl3row" style="display:none">
        <label class="flabel">–¢–ï–ö–°–¢ –ó–û–ù–´ 3</label>
        <input type="text" id="nLbl3" placeholder="–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ç—Ä–µ—Ç—å–µ —Ñ–æ—Ç–æ">
      </div>
      <div class="frow" id="lbl4row" style="display:none">
        <label class="flabel">–¢–ï–ö–°–¢ –ó–û–ù–´ 4</label>
        <input type="text" id="nLbl4" placeholder="–ó–∞–≥—Ä—É–∑–∏—Ç–µ —á–µ—Ç–≤—ë—Ä—Ç–æ–µ —Ñ–æ—Ç–æ">
      </div>

      <div class="frow"><label class="flabel">–ü–†–û–ú–ü–¢ –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò</label><textarea id="nPrompt" placeholder="–ü—Ä–æ–º–ø—Ç –∫–æ—Ç–æ—Ä—ã–π —É–π–¥—ë—Ç –≤ API –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏"></textarea></div>
      <div class="frow"><label class="flabel">–ö–ê–¢–ï–ì–û–†–ò–Ø</label><select id="nCat"></select></div>
      <div class="frow"><label class="flabel">–°–¢–û–ò–ú–û–°–¢–¨ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–π)</label><input type="number" id="nCost" value="10" min="1" max="50"></div>
      <div class="frow">
        <label class="flabel">–û–†–ò–ï–ù–¢–ê–¶–ò–Ø –ü–õ–ò–¢–ö–ò</label>
        <select id="nRatio">
          <option value="9:16">9:16 ‚Äî –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)</option>
          <option value="16:9">16:9 ‚Äî –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è (—à–∏—Ä–æ–∫–∞—è)</option>
          <option value="1:1">1:1 ‚Äî –ö–≤–∞–¥—Ä–∞—Ç</option>
        </select>
      </div>

      <button class="btn-y" style="width:100%;margin-top:4px;font-size:14px" onclick="addTemplate()">+ –î–û–ë–ê–í–ò–¢–¨ –®–ê–ë–õ–û–ù</button>
    </div>

    <div class="adm-sec">–®–ê–ë–õ–û–ù–´</div>
    <div class="adm-list" id="admList"></div>

  </div>
  <div class="adm-btm">
    <button class="btn-ghost" style="width:100%;height:46px;border-radius:10px" onclick="closeAdmin()">–ó–ê–ö–†–´–¢–¨</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê CONFIRM MODAL ‚ïê‚ïê‚ïê‚ïê -->
<div class="confirm-modal" id="confirmModal">
  <div class="confirm-box">
    <div class="confirm-ico">üóë</div>
    <div class="confirm-title">–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω?</div>
    <div class="confirm-sub" id="confirmSubText">–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å</div>
    <div class="confirm-btns">
      <button class="btn-ghost" style="flex:1;height:44px;border-radius:9px" onclick="closeConfirm()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn-danger" id="confirmOkBtn">–£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê EDIT TEMPLATE SHEET ‚ïê‚ïê‚ïê‚ïê -->
<div id="editTplSheet" class="overlay" onclick="editSheetBgClose(event)">
  <div class="sheet">
    <div class="s-handle"></div>
    <div class="s-hdr">
      <div class="s-title">–†–ï–î–ê–ö–¢–ò–†–û–í–ê–¢–¨</div>
      <div class="s-sub" id="editSheetSub">–ò–∑–º–µ–Ω–µ–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞</div>
    </div>
    <div class="s-body">
      <input type="hidden" id="editTplId">

      <!-- preview -->
      <div class="frow">
        <label class="flabel">–ü–†–ï–í–¨–Æ (—Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ)</label>
        <div class="mtoggle">
          <button class="mtype on" id="editAdmTypeImg" onclick="setEditMedia('image')"><svg viewBox="0 0 16 16"><rect x="1" y="2" width="14" height="12" rx="2"/><circle cx="8" cy="8" r="2.5"/></svg>–§–û–¢–û</button>
          <button class="mtype" id="editAdmTypeVid" onclick="setEditMedia('video')"><svg viewBox="0 0 16 16"><polygon points="6,4 6,12 12,8"/></svg>–í–ò–î–ï–û</button>
        </div>
        <div class="prev-zone" id="editPrevZone" onclick="document.getElementById('editAdmFile').click()">
          <div style="font-size:20px;opacity:.4" id="editPrevIco">üñº</div>
          <div style="font-size:11px;color:var(--mu)" id="editPrevTxt">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–º–µ–Ω—ã –ø—Ä–µ–≤—å—é</div>
          <input type="file" id="editAdmFile" accept="image/*,video/*" style="display:none" onchange="handleEditPreview(this)">
          <img id="editPrevImg" alt="" style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:none">
          <video id="editPrevVid" muted loop playsinline style="position:absolute;inset:0;width:100%;height:100%;object-fit:cover;display:none"></video>
        </div>
      </div>

      <div class="frow"><label class="flabel">–ù–ê–ó–í–ê–ù–ò–ï</label><input type="text" id="eName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞"></div>
      <div class="frow"><label class="flabel">–û–ü–ò–°–ê–ù–ò–ï</label><input type="text" id="eDesc" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ"></div>
      <div class="frow">
        <label class="flabel">–¢–ò–ü –®–ê–ë–õ–û–ù–ê</label>
        <div class="ttype-row" style="grid-template-columns:1fr 1fr 1fr 1fr">
          <div class="ttype-opt" data-etype="single" onclick="selEtype(this,'single')"><div class="tto-n">1</div><div class="tto-lbl">–§–û–¢–û</div></div>
          <div class="ttype-opt" data-etype="double" onclick="selEtype(this,'double')"><div class="tto-n">2</div><div class="tto-lbl">–§–û–¢–û</div></div>
          <div class="ttype-opt" data-etype="triple" onclick="selEtype(this,'triple')"><div class="tto-n">3</div><div class="tto-lbl">–§–û–¢–û</div></div>
          <div class="ttype-opt" data-etype="quad" onclick="selEtype(this,'quad')"><div class="tto-n">4</div><div class="tto-lbl">–§–û–¢–û</div></div>
        </div>
        <input type="hidden" id="eType" value="single">
      </div>
      <div class="frow"><label class="flabel">–¢–ï–ö–°–¢ –ó–û–ù–´ 1</label><input type="text" id="eLbl1" placeholder="–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à–µ —Ñ–æ—Ç–æ"></div>
      <div class="frow" id="eLbl2row" style="display:none"><label class="flabel">–¢–ï–ö–°–¢ –ó–û–ù–´ 2</label><input type="text" id="eLbl2" placeholder="–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤—Ç–æ—Ä–æ–µ —Ñ–æ—Ç–æ"></div>
      <div class="frow" id="eLbl3row" style="display:none"><label class="flabel">–¢–ï–ö–°–¢ –ó–û–ù–´ 3</label><input type="text" id="eLbl3" placeholder="–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ç—Ä–µ—Ç—å–µ —Ñ–æ—Ç–æ"></div>
      <div class="frow" id="eLbl4row" style="display:none"><label class="flabel">–¢–ï–ö–°–¢ –ó–û–ù–´ 4</label><input type="text" id="eLbl4" placeholder="–ó–∞–≥—Ä—É–∑–∏—Ç–µ —á–µ—Ç–≤—ë—Ä—Ç–æ–µ —Ñ–æ—Ç–æ"></div>
      <div class="frow"><label class="flabel">–ü–†–û–ú–ü–¢ –î–õ–Ø –ì–ï–ù–ï–†–ê–¶–ò–ò</label><textarea id="ePrompt" placeholder="–ü—Ä–æ–º–ø—Ç –¥–ª—è API"></textarea></div>
      <div class="frow"><label class="flabel">–ö–ê–¢–ï–ì–û–†–ò–Ø</label><select id="eCat"></select></div>
      <div class="frow"><label class="flabel">–°–¢–û–ò–ú–û–°–¢–¨ (–≥–µ–Ω.)</label><input type="number" id="eCost" min="1" max="50"></div>
      <div class="frow">
        <label class="flabel">–û–†–ò–ï–ù–¢–ê–¶–ò–Ø –ü–õ–ò–¢–ö–ò</label>
        <select id="eRatio">
          <option value="9:16">9:16 ‚Äî –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–∞—è</option>
          <option value="16:9">16:9 ‚Äî –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–∞—è</option>
          <option value="1:1">1:1 ‚Äî –ö–≤–∞–¥—Ä–∞—Ç</option>
        </select>
      </div>
    </div>
    <div class="s-footer">
      <button class="btn-ghost" onclick="closeEditSheet()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn-y" onclick="saveEditTemplate()">üíæ –°–û–•–†–ê–ù–ò–¢–¨</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê ERROR DISPLAY (debug) ‚ïê‚ïê
window.onerror = function(msg, src, line, col, err) {
  var div = document.createElement('div');
  div.style.cssText = 'position:fixed;bottom:0;left:0;right:0;background:#D45A5A;color:#fff;padding:10px;font-size:12px;z-index:9999;word-break:break-all';
  div.textContent = 'ERR L'+line+': '+msg;
  document.body.appendChild(div);
  return false;
};

// ‚ïê‚ïê CANVAS BG ‚Äî GLOW BLOBS + PARTICLES ‚ïê‚ïê
(function(){
  var cv=document.getElementById('bgc'),ctx=cv.getContext('2d');
  var W,H,t=0,pts=[];
  var LIME='184,255,0',CORAL='255,77,109',CYAN='80,200,255';

  var blobDefs=[
    // –ª–µ–≤—ã–π –≤–µ—Ä—Ö ‚Äî –ª–∞–π–º
    {ox:.15,oy:.15,sx:.12,sy:.10,ph:0,   spx:.50,spy:.40,col:LIME,  a:.18,rx:.50,ry:.42},
    // –ø—Ä–∞–≤—ã–π –≤–µ—Ä—Ö ‚Äî –∫–æ—Ä–∞–ª (—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–æ)
    {ox:.85,oy:.15,sx:.12,sy:.10,ph:1.5, spx:.48,spy:.38,col:CORAL, a:.18,rx:.50,ry:.42},
    // —Ü–µ–Ω—Ç—Ä ‚Äî –≥–æ–ª—É–±–æ–π
    {ox:.50,oy:.50,sx:.16,sy:.14,ph:2.4, spx:.30,spy:.35,col:CYAN,  a:.10,rx:.48,ry:.44},
    // –ª–µ–≤—ã–π –Ω–∏–∑ ‚Äî –ª–∞–π–º
    {ox:.15,oy:.80,sx:.11,sy:.11,ph:0.8, spx:.42,spy:.48,col:LIME,  a:.15,rx:.44,ry:.36},
    // –ø—Ä–∞–≤—ã–π –Ω–∏–∑ ‚Äî –∫–æ—Ä–∞–ª (—Å–∏–º–º–µ—Ç—Ä–∏—á–Ω–æ)
    {ox:.85,oy:.80,sx:.11,sy:.11,ph:3.0, spx:.38,spy:.44,col:CORAL, a:.15,rx:.44,ry:.36},
    // –≤–µ—Ä—Ö —Ü–µ–Ω—Ç—Ä ‚Äî —Ñ–∏–æ–ª–µ—Ç
    {ox:.50,oy:.12,sx:.14,sy:.09,ph:1.8, spx:.34,spy:.28,col:'180,120,255',a:.08,rx:.38,ry:.30},
  ];

  function rsz(){
    W=cv.width=window.innerWidth;H=cv.height=window.innerHeight;
    pts=[];
    var n=Math.min(48,Math.floor(W*H/9000));
    for(var i=0;i<n;i++) pts.push(mkPt());
  }

  function mkPt(){
    var cols=[LIME,CORAL,CYAN];
    return{
      x:Math.random()*W,y:Math.random()*H,
      vx:(Math.random()-.5)*.35,vy:(Math.random()-.5)*.35,
      r:Math.random()*1.6+.4,
      col:cols[Math.floor(Math.random()*cols.length)],
      a:Math.random()*.35+.2,
      ph:Math.random()*Math.PI*2,
      ps:Math.random()*.012+.005,
      type:Math.random()>.65?'cross':'dot'
    };
  }

  function drawBlob(cx,cy,rx,ry,col,alpha){
    ctx.save();ctx.translate(cx,cy);ctx.scale(1,ry/rx);
    var g=ctx.createRadialGradient(0,0,0,0,0,rx);
    g.addColorStop(0,'rgba('+col+','+alpha+')');
    g.addColorStop(.4,'rgba('+col+','+(alpha*.5)+')');
    g.addColorStop(.8,'rgba('+col+','+(alpha*.1)+')');
    g.addColorStop(1,'rgba('+col+',0)');
    ctx.fillStyle=g;ctx.beginPath();ctx.arc(0,0,rx,0,Math.PI*2);ctx.fill();
    ctx.restore();
  }

  function frame(){
    t+=.004;
    ctx.fillStyle='#070707';ctx.fillRect(0,0,W,H);

    // blobs
    blobDefs.forEach(function(b){
      var cx=W*(b.ox+Math.sin(t*b.spx+b.ph)*b.sx);
      var cy=H*(b.oy+Math.cos(t*b.spy+b.ph+1)*b.sy);
      var alpha=b.a*(.8+.2*Math.sin(t*1.1+b.ph));
      drawBlob(cx,cy,W*b.rx,H*b.ry,b.col,alpha);
    });

    // particles
    pts.forEach(function(p,i){
      p.x+=p.vx;p.y+=p.vy;p.ph+=p.ps;
      if(p.x<0)p.x=W;if(p.x>W)p.x=0;
      if(p.y<0)p.y=H;if(p.y>H)p.y=0;
      var alpha=p.a*(.55+.45*Math.sin(p.ph));
      for(var j=i+1;j<pts.length;j++){
        var dx=pts[j].x-p.x,dy=pts[j].y-p.y,dist=Math.sqrt(dx*dx+dy*dy);
        if(dist<85){
          ctx.strokeStyle='rgba('+p.col+','+(alpha*(1-dist/85)*.25)+')';
          ctx.lineWidth=.4;ctx.beginPath();ctx.moveTo(p.x,p.y);ctx.lineTo(pts[j].x,pts[j].y);ctx.stroke();
        }
      }
      if(p.type==='cross'){
        ctx.strokeStyle='rgba('+p.col+','+alpha+')';ctx.lineWidth=.9;
        ctx.beginPath();
        ctx.moveTo(p.x-p.r*2.2,p.y);ctx.lineTo(p.x+p.r*2.2,p.y);
        ctx.moveTo(p.x,p.y-p.r*2.2);ctx.lineTo(p.x,p.y+p.r*2.2);
        ctx.stroke();
      }else{
        ctx.fillStyle='rgba('+p.col+','+alpha+')';
        ctx.beginPath();ctx.arc(p.x,p.y,p.r,0,Math.PI*2);ctx.fill();
      }
    });

    requestAnimationFrame(frame);
  }

  window.addEventListener('resize',rsz);
  rsz();frame();
})();

// ‚ïê‚ïê CONFIG ‚ïê‚ïê
// Set your Telegram user IDs here ‚Äî these users will see the admin panel
const ADMIN_IDS=[1066928889];
// Get tg user id if available (will work when deployed in Telegram)
const TG_USER_ID=(()=>{try{var tgw=window.Telegram&&window.Telegram.WebApp;var d=tgw&&tgw.initDataUnsafe&&tgw.initDataUnsafe.user&&tgw.initDataUnsafe.user.id;return d||null}catch(e){return null}})();

// ‚ïê‚ïê STATE ‚ïê‚ïê
const RATIOS_MAIN=['AUTO','9:16','16:9','1:1'];
const RATIOS_MORE=['3:4','4:3','3:2','2:3','5:4','4:5','21:9'];
let selRatio='AUTO',curNav='templates',curCat='all',upLevel='1K',upCost=1,selTpl=null;
let selectedTtype='single';

const CAT_EMOJIS=['‚ú®','üé®','üëó','üíá','üíÑ','üå∏','üéñ','‚öîÔ∏è','üåø','üåÜ','üì∏','ü§ñ','üê±','ü¶ã','üåä','üî•','üíé','üåô','üé≠','üé¨','üéµ','üèÜ','üçå','ü¶Ñ','üå∫','üé™','üèô','üåå','üëë','ü¶Ö'];
let selectedCatEmoji='‚ú®';

// —Å–∏–º–≤–æ–ª-–º–∞–ø–ø–∏–Ω–≥ –ø–æ id –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
const CAT_SYMBOLS={
  'all':'‚óà','hairstyle':'‚åÄ','outfit':'‚óá','postcard':'‚¨°',
  'portrait':'‚óâ','anime':'‚ú¶','fantasy':'‚üÅ',
  'beauty':'‚óà','nature':'‚äï','city':'‚ñ£','music':'‚óé',
  'food':'‚¨ü','sport':'‚ñ≥','tech':'‚äû','art':'‚úß',
  'travel':'‚ó¨','love':'‚óá','dark':'‚ñ≤','light':'‚óã'
};
function getCatSymbol(id,emoji){
  return CAT_SYMBOLS[id]||'‚óà';
}

let categories=JSON.parse(localStorage.getItem('nb_cats')||'null')||[
  {id:'all',label:'–í–°–ï',emoji:''},
  {id:'hairstyle',label:'–ü–†–ò–ß–ï–°–ö–ò',emoji:'üíá'},
  {id:'outfit',label:'–û–î–ï–ñ–î–ê',emoji:'üëó'},
  {id:'postcard',label:'–û–¢–ö–†–´–¢–ö–ò',emoji:'üéñ'},
  {id:'portrait',label:'–ü–û–†–¢–†–ï–¢',emoji:'üì∏'},
  {id:'anime',label:'–ê–ù–ò–ú–ï',emoji:'üå∏'},
  {id:'fantasy',label:'–§–≠–ù–¢–ï–ó–ò',emoji:'‚öîÔ∏è'},
];

let templates=JSON.parse(localStorage.getItem('nb_tpl3')||'null')||[
  {id:1,name:'–°–º–µ–Ω–∞ –ø—Ä–∏—á—ë—Å–∫–∏',description:'–ü–æ–ø—Ä–æ–±—É–π –Ω–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –ø—Ä–∏—á–µ—Å–∫–∏',type:'single',lbl1:'–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à–µ —Ñ–æ—Ç–æ',lbl2:'',prompt:'Change hairstyle realistic',category:'hairstyle',cost:20,active:true,preview:null,previewType:'image',uses:1240,defaultRatio:'9:16'},
  {id:2,name:'–ü—Ä–∏–º–µ—Ä–∫–∞ –æ–¥–µ–∂–¥—ã',description:'–ù–∞–¥–µ–Ω—å –ª—é–±—É—é –æ–¥–µ–∂–¥—É –Ω–∞ —Å–≤–æ—ë —Ñ–æ—Ç–æ',type:'double',lbl1:'–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à–µ —Ñ–æ—Ç–æ',lbl2:'–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ –æ–¥–µ–∂–¥—ã',prompt:'Try on clothes',category:'outfit',cost:30,active:true,preview:null,previewType:'image',uses:876,defaultRatio:'9:16'},
  {id:3,name:'–û—Ç–∫—Ä—ã—Ç–∫–∞: 23 —Ñ–µ–≤—Ä–∞–ª—è',description:'–ü–æ–∑–¥—Ä–∞–≤—å –±–ª–∏–∑–∫–æ–≥–æ —Å 23 –§–µ–≤—Ä–∞–ª—è',type:'single',lbl1:'–ó–∞–≥—Ä—É–∑–∏—Ç–µ –æ–¥–Ω–æ —Ñ–æ—Ç–æ',lbl2:'',prompt:'Military postcard',category:'postcard',cost:20,active:true,preview:null,previewType:'image',uses:3520,defaultRatio:'9:16'},
  {id:4,name:'–ê–Ω–∏–º–µ –ø–æ—Ä—Ç—Ä–µ—Ç',description:'–ü—Ä–µ–≤—Ä–∞—Ç–∏—Å—å –≤ –∞–Ω–∏–º–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞',type:'single',lbl1:'–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à–µ —Ñ–æ—Ç–æ',lbl2:'',prompt:'Anime portrait',category:'anime',cost:15,active:true,preview:null,previewType:'image',uses:2100,defaultRatio:'9:16'},
  {id:5,name:'Oil Painting',description:'–í–∞—à –ø–æ—Ä—Ç—Ä–µ—Ç –∫–∞–∫ –∫–∞—Ä—Ç–∏–Ω–∞ –º–∞—Å–ª–æ–º',type:'single',lbl1:'–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à–µ —Ñ–æ—Ç–æ',lbl2:'',prompt:'Oil painting portrait',category:'portrait',cost:15,active:true,preview:null,previewType:'image',uses:430,defaultRatio:'9:16'},
];

function saveTpl(){localStorage.setItem('nb_tpl3',JSON.stringify(templates))}

// ‚ïê‚ïê MEDIA HTML HELPERS (no nested template literals for Safari compat) ‚ïê‚ïê
function mediaHtml(preview, previewType, emoji, fontSize) {
  if (!preview) return '<div class="tcard-emoji" style="display:flex;flex-direction:column;align-items:center;justify-content:center;width:100%;height:100%;background:linear-gradient(145deg,#141414,#0a0a0a);gap:8px">'
    +'<div style="font-size:'+(fontSize||'32px')+';opacity:.5">'+emoji+'</div>'
    +'<div style="font-size:9px;letter-spacing:2px;color:rgba(255,255,255,.15);font-family:Barlow Condensed,sans-serif;font-weight:700">–ù–ï–¢ –ü–†–ï–í–¨–Æ</div>'
    +'</div>';
  if (previewType === 'video') return '<video src="'+preview+'" autoplay muted loop playsinline></video>';
  return '<img src="'+preview+'" alt="">';
}
function thumbHtml(preview, previewType, emoji) {
  if (!preview) return emoji || 'üé®';
  if (previewType === 'video') return '<video src="'+preview+'" autoplay muted loop playsinline></video>';
  return '<img src="'+preview+'">';
}
function saveCats(){localStorage.setItem('nb_cats',JSON.stringify(categories))}

// ‚ïê‚ïê ADMIN CHECK ‚ïê‚ïê
function checkAdmin(){
  var isAdmin = !TG_USER_ID || (ADMIN_IDS.indexOf(TG_USER_ID) !== -1);
  if(isAdmin){
    var ab = document.getElementById('adminBtn');
    if(ab) ab.classList.remove('hidden');
  }
}

// ‚ïê‚ïê CATS BAR ‚ïê‚ïê
function renderCatsBar(){
  const bar=document.getElementById('catsBar');
  bar.innerHTML=categories.map(function(cat){
    var lbl=cat.id==='all'?'–í–°–ï':cat.label.toUpperCase();
    var isOn=cat.id===curCat?'on':'';
    return '<button class="cat '+isOn+'" onclick="setCat(this,\''+cat.id+'\')">'+lbl+'</button>';
  }).join('');
}
function setCat(el,cat){
  document.querySelectorAll('.cat').forEach(b=>b.classList.remove('on'));
  el.classList.add('on');curCat=cat;renderTemplates();
}

// ‚ïê‚ïê TEMPLATES ‚ïê‚ïê
function fmtU(n){return n>=1000?(n/1000).toFixed(1)+'K':n}
function catL(id){const c=categories.find(x=>x.id===id);return c?c.label:id.toUpperCase()}

function renderTemplates(forceCat){
  const g=document.getElementById('tgrid');
  const cat=forceCat||curCat;
  templates.forEach(t=>{if(!t.defaultRatio)t.defaultRatio='9:16'});
  const list=templates
    .filter(t=>t.active&&(cat==='all'||t.category===cat))
    .sort((a,b)=>(b.uses||0)-(a.uses||0));
  if(!list.length){g.innerHTML='<div class="empty"><div class="ei">üé®</div>–®–∞–±–ª–æ–Ω–æ–≤ –≤ —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ—Ç</div>';return}
  function ar(r){return r==='16:9'?'16/9':r==='1:1'?'1/1':'9/16';}
  g.innerHTML=list.map(function(t,idx){
    return '<div class="tcard '+(t.defaultRatio==='16:9'?'wide':'')+'" onclick="openTemplate('+t.id+')">'
      +'<div class="tcard-shimmer"></div>'
      +'<div class="tcard-media" style="aspect-ratio:'+ar(t.defaultRatio)+'">'
      +mediaHtml(t.preview,t.previewType,t.emoji||'üé®','32px')
      +'</div>'
      +'<div class="tcard-body">'
      +'<div class="tcard-name">'+t.name+'</div>'
      +'<div class="tcard-meta">'
      +'<div class="cat-tag">'+catL(t.category)+'</div>'
      +'<div style="display:flex;align-items:center;gap:6px">'
      +'<div class="use-c"><svg viewBox="0 0 16 16"><path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm5 5a5 5 0 0 0-10 0h10z"/></svg>'+fmtU(t.uses||0)+'</div>'
      +'<div class="cost-pin">‚ö°'+t.cost+'</div>'
      +'</div>'
      +'</div>'
      +'</div>'
      +'</div>';
  }).join('');
}

// ‚ïê‚ïê NAV ‚ïê‚ïê
function switchNav(nav){
  document.querySelectorAll('.navbtn').forEach(function(b){b.classList.remove('on');});
  var nb=document.getElementById('nav-'+nav);if(nb){nb.classList.add('on');}
  ['templates','create','edit','upscale','history'].forEach(function(t){var el=document.getElementById('tab-'+t);if(el)el.style.display=t===nav?'':'none';});
  if(nav==='history') renderHistory();
  // move indicator
  var ind=document.getElementById('navIndicator');
  if(nb&&ind){
    var nr=nb.getBoundingClientRect();
    var pr=nb.parentElement.getBoundingClientRect();
    ind.style.left=(nr.left-pr.left)+'px';
    ind.style.width=nr.width+'px';
  }
  curNav=nav;
}

// ‚ïê‚ïê RATIOS ‚ïê‚ïê
function buildRatios(id){
  var el=document.getElementById(id);if(!el)return;
  var mainBtns=RATIOS_MAIN.map(function(r){
    return '<button class="rpill '+(r===selRatio?'on':'')+'" onclick="pickRatio(this,\''+r+'\',\''+id+'\')">'+(r==='AUTO'?'üîÑ –ê–í–¢–û':r)+'</button>';
  }).join('');
  var moreBtns=RATIOS_MORE.map(function(r){
    return '<button class="rpill" onclick="pickRatio(this,\''+r+'\',\''+id+'\'">'+r+'</button>';
  }).join('');
  el.innerHTML='<div class="ratio-row" id="'+id+'-main">'+mainBtns+'<button class="rpill more-btn" onclick="toggleMore(\''+id+'-more\',this)">–ï–©–Å ‚ñæ</button></div>'
    +'<div class="more-ratios" id="'+id+'-more">'+moreBtns+'</div>';
}
function pickRatio(el,r,id){
  document.querySelectorAll('#'+id+'-main .rpill:not(.more-btn),#'+id+'-more .rpill').forEach(function(b){b.classList.remove('on');});
  el.classList.add('on');selRatio=r;
  if(RATIOS_MORE.indexOf(r)!==-1){var _m=document.getElementById(id+'-more');if(_m)_m.classList.add('open');}
}
function toggleMore(mid,btn){
  const m=document.getElementById(mid);const o=m.classList.toggle('open');btn.textContent=o?'–°–ö–†–´–¢–¨ ‚ñ¥':'–ï–©–Å ‚ñæ';
}
function setUpscale(el,lv,cost){
  document.querySelectorAll('#tab-upscale .rpill').forEach(b=>b.classList.remove('on'));
  el.classList.add('on');upLevel=lv;upCost=cost;
  document.getElementById('upscaleBtn').textContent='‚ö° –ê–ü–°–ö–ï–ô–õ '+lv+' ¬∑ '+cost+' –≥–µ–Ω.';
}

// ‚ïê‚ïê ZONES ‚ïê‚ïê
function handleZone(input,zoneId){
  const f=input.files[0];if(!f)return;
  const z=document.getElementById(zoneId);
  const thumb=z.querySelector('.upzone-thumb'),vid=z.querySelector('.upzone-vid');
  if(f.type.startsWith('video/')){
    thumb.style.display='none';vid.src=URL.createObjectURL(f);vid.style.display='block';vid.play();
  }else{
    vid.style.display='none';
    const rd=new FileReader();rd.onload=e=>{thumb.src=e.target.result;thumb.style.display='block'};rd.readAsDataURL(f);
  }
  z.classList.add('has-file');
}
function clearZone(zid,tid,vid,e){
  e&&e.stopPropagation();
  const z=document.getElementById(zid);
  const t=z.querySelector('.upzone-thumb'),v=z.querySelector('.upzone-vid');
  if(t){t.src='';t.style.display='none'}if(v){v.src='';v.style.display='none'}
  z.classList.remove('has-file');
  const inp=z.querySelector('input[type=file]');if(inp)inp.value='';
}

// ‚ïê‚ïê TEMPLATE SHEET ‚ïê‚ïê
function openTemplate(id){
  selTpl=templates.find(t=>t.id===id);if(!selTpl)return;
  document.getElementById('st-title').textContent=selTpl.name;
  document.getElementById('st-sub').textContent=selTpl.description;
  document.getElementById('st-genlabel').textContent='–°–û–ó–î–ê–¢–¨ ¬∑ '+selTpl.cost+' –≥–µ–Ω.';
  buildSheetBody();
  openOverlay('tmplOvl');
}
function buildSheetBody(){
  const t=selTpl,body=document.getElementById('st-body');
  sheetPhotos=[null,null,null,null];
  // –æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∞–ª—å–Ω–æ–µ —Å–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –ø—Ä–µ–≤—å—é –ø–æ —Ä–∞–∑–º–µ—Ä—É –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
  if(t.preview && t.previewType!=='video'){
    var img=new Image();
    img.onload=function(){
      var realRatio=img.naturalWidth/img.naturalHeight;
      _renderSheetBody(t,body,realRatio);
    };
    img.src=t.preview;
  } else {
    _renderSheetBody(t,body,null);
  }
}
function _renderSheetBody(t,body,realRatio){
  var usesHtml='<div class="s-banner-uses"><svg viewBox="0 0 16 16" width="10" height="10" fill="rgba(255,255,255,.5)"><path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6zm5 5a5 5 0 0 0-10 0h10z"/></svg>'+fmtU(t.uses||0)+' –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>';
  var html;
  // realRatio: >1.2 = landscape, <0.8 = portrait, –∏–Ω–∞—á–µ square
  var isPortrait = realRatio ? realRatio < 0.85 : t.defaultRatio==='9:16';
  var isLandscape = realRatio ? realRatio > 1.2 : t.defaultRatio==='16:9';

  if(isPortrait){
    html='<div class="s-banner s-banner-916">'
      +'<div class="s-banner-media" style="width:100%;height:280px;display:flex;align-items:center;justify-content:center;overflow:hidden;">'
      +'<img src="'+t.preview+'" style="height:100%;width:auto;object-fit:contain;display:block;margin:0 auto;">'
      +'</div>'
      +'<div class="s-banner-cost">‚ö° '+t.cost+'</div>'
      +usesHtml
      +'</div>';
  } else if(isLandscape){
    html='<div class="s-banner">'
      +'<div class="s-banner-media" style="width:100%;margin:0 auto;aspect-ratio:'+(realRatio?realRatio.toFixed(4)+'/1':'16/9')+';max-height:280px;">'
      +mediaHtml(t.preview,t.previewType,t.emoji||'üé®','44px')
      +'</div>'
      +'<div class="s-banner-cost">‚ö° '+t.cost+'</div>'
      +usesHtml
      +'</div>';
  } else {
    html='<div class="s-banner">'
      +'<div class="s-banner-media" style="width:94%;margin:0 auto;aspect-ratio:1/1;max-height:280px;">'
      +mediaHtml(t.preview,t.previewType,t.emoji||'üé®','44px')
      +'</div>'
      +'<div class="s-banner-cost">‚ö° '+t.cost+'</div>'
      +usesHtml
      +'</div>';
  }
  var zoneCount={'single':1,'double':2,'triple':3,'quad':4}[t.type]||1;
  var zlbls=[t.lbl1||'–§–æ—Ç–æ 1',t.lbl2||'–§–æ—Ç–æ 2',t.lbl3||'–§–æ—Ç–æ 3',t.lbl4||'–§–æ—Ç–æ 4'];
  if(zoneCount===1){
    html+='<div class="frow"><label class="flabel">–§–û–¢–û</label>';
    html+='<div class="multi-zone" style="grid-template-columns:1fr;">';
    html+='<div class="mz-slot mz-slot-glow" id="sm-0" onclick="triggerSheetSlot(0)" style="border-right:none;">';
    html+='<svg viewBox="0 0 24 24" width="22" height="22" stroke="rgba(184,255,0,.35)" fill="none"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>';
    html+='<span style="font-size:10px;text-align:center;padding:0 4px">'+zlbls[0]+'</span>';
    html+='<input type="file" id="smf-0" accept="image/*" style="display:none" onchange="addSheetPhoto(this,0)">';
    html+='</div>';
    html+='</div></div>';
  } else {
    html+='<div class="frow"><label class="flabel">–§–û–¢–û <span style="color:var(--mu);font-weight:400;letter-spacing:0;text-transform:none;font-size:10px">('+zoneCount+' —Ñ–æ—Ç–æ)</span></label><div class="multi-zone">';
    for(var zi=0;zi<zoneCount;zi++){
      var lbl=zlbls[zi];
      html+='<div class="mz-slot mz-slot-glow" id="sm-'+zi+'" onclick="triggerSheetSlot('+zi+')">';
      html+='<svg viewBox="0 0 24 24" width="22" height="22" stroke="rgba(184,255,0,.35)" fill="none"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>';
      html+='<span style="font-size:10px;text-align:center;padding:0 4px">'+lbl+'</span>';
      html+='<input type="file" id="smf-'+zi+'" accept="image/*" style="display:none" onchange="addSheetPhoto(this,'+zi+')">';
      html+='</div>';
    }
    html+='</div></div>';
  }
  html+='<div class="frow"><label class="flabel">–°–û–û–¢–ù–û–®–ï–ù–ò–ï –°–¢–û–†–û–ù</label><div id="ratioSheet"></div></div>';
  body.innerHTML=html;
  buildRatios('ratioSheet');
}

var sheetPhotos=[null,null,null,null];
function triggerSheetSlot(idx){
  var slot=document.getElementById('sm-'+idx);
  if(slot&&slot.classList.contains('has-img'))return;
  var fi=document.getElementById('smf-'+idx);if(fi)fi.click();
}
function addSheetPhoto(input,idx){
  var f=input.files[0];if(!f)return;
  var slot=document.getElementById('sm-'+idx);
  var reader=new FileReader();
  reader.onload=function(e){
    sheetPhotos[idx]=e.target.result;
    slot.innerHTML='<img class="mz-img" src="'+e.target.result+'">'
      +'<div class="mz-del" onclick="removeSheetPhoto(event,'+idx+')">‚úï</div>'
      +'<div class="mz-num">'+(idx+1)+'</div>'
      +'<input type="file" id="smf-'+idx+'" accept="image/*" style="display:none" onchange="addSheetPhoto(this,'+idx+')">';
    slot.classList.add('has-img');
  };
  reader.readAsDataURL(f);
}
function removeSheetPhoto(e,idx){
  e.stopPropagation();
  sheetPhotos[idx]=null;
  var slot=document.getElementById('sm-'+idx);
  var lbl=selTpl?(selTpl['lbl'+(idx+1)]||'–§–æ—Ç–æ '+(idx+1)):'–§–æ—Ç–æ '+(idx+1);
  slot.innerHTML='<svg viewBox="0 0 24 24" width="22" height="22" stroke="rgba(184,255,0,.35)" fill="none"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>'
    +'<span style="font-size:10px;text-align:center;padding:0 4px">'+lbl+'</span>'
    +'<input type="file" id="smf-'+idx+'" accept="image/*" style="display:none" onchange="addSheetPhoto(this,'+idx+')">';
  slot.classList.remove('has-img');
}
function triggerSheetSlot(idx){
  var slot=document.getElementById('sm-'+idx);
  if(slot&&slot.classList.contains('has-img'))return;
  var fi=document.getElementById('smf-'+idx);if(fi)fi.click();
}
function addSheetPhoto(input,idx){
  var f=input.files[0];if(!f)return;
  var slot=document.getElementById('sm-'+idx);
  var reader=new FileReader();
  reader.onload=function(e){
    sheetPhotos[idx]=e.target.result;
    slot.innerHTML='<img class="mz-img" src="'+e.target.result+'">'
      +'<div class="mz-del" onclick="removeSheetPhoto(event,'+idx+')">‚úï</div>'
      +'<div class="mz-num">'+(idx+1)+'</div>'
      +'<input type="file" id="smf-'+idx+'" accept="image/*" style="display:none" onchange="addSheetPhoto(this,'+idx+')">';
    slot.classList.add('has-img');
  };
  reader.readAsDataURL(f);
}
function removeSheetPhoto(e,idx){
  e.stopPropagation();
  sheetPhotos[idx]=null;
  var slot=document.getElementById('sm-'+idx);
  var lbl=selTpl?(selTpl['lbl'+(idx+1)]||'–§–æ—Ç–æ '+(idx+1)):'–§–æ—Ç–æ '+(idx+1);
  slot.innerHTML='<svg viewBox="0 0 24 24" width="22" height="22" stroke="rgba(184,255,0,.35)" fill="none"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>'
    +'<span style="font-size:10px;text-align:center;padding:0 4px">'+lbl+'</span>'
    +'<input type="file" id="smf-'+idx+'" accept="image/*" style="display:none" onchange="addSheetPhoto(this,'+idx+')">';
  slot.classList.remove('has-img');
}
function clearZoneInline(e,zid){
  e.stopPropagation();
  const z=document.getElementById(zid);
  const t=z.querySelector('.upzone-thumb'),v=z.querySelector('.upzone-vid');
  if(t){t.src='';t.style.display='none'}if(v){v.src='';v.style.display='none'}
  z.classList.remove('has-file');const inp=z.querySelector('input');if(inp)inp.value='';
}
// ‚ïê‚ïê BACKEND CONFIG ‚ïê‚ïê
// –ó–∞–º–µ–Ω–∏ –Ω–∞ IP/–¥–æ–º–µ–Ω —Å–≤–æ–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ –≥–¥–µ –∑–∞–ø—É—â–µ–Ω run_all.py
const BACKEND_URL = 'http://YOUR_SERVER_IP:8000';

function syncBalance(){
  const userId = getTgUserId();
  if(userId === 'dev_user') return;
  fetch(BACKEND_URL + '/balance/' + userId)
    .then(r => r.json())
    .then(data => {
      if(typeof data.balance === 'number'){
        document.querySelector('.gen-count') && (document.querySelector('.gen-count').childNodes[1].textContent = ' ' + data.balance);
      }
    })
    .catch(()=>{});
}


  try{var tg=window.Telegram&&window.Telegram.WebApp;var id=tg&&tg.initDataUnsafe&&tg.initDataUnsafe.user&&tg.initDataUnsafe.user.id;return id?String(id):'dev_user';}catch(e){return 'dev_user';}
}

function doGenerate(){
  if(!selTpl) return;
  const userId = getTgUserId();
  const ratioEl = document.querySelector('#ratioSheet .rpill.on');
  const imageSize = ratioEl ? (ratioEl.dataset.ratio||'1:1') : '1:1';

  const btn = document.getElementById('st-genbtn');
  const lbl = document.getElementById('st-genlabel');
  btn.disabled = true;
  lbl.textContent = '–û–¢–ü–†–ê–í–õ–Ø–ï–ú...';

  fetch(BACKEND_URL + '/generate', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      telegram_user_id: userId,
      prompt: selTpl.prompt || 'Generate image',
      image_size: imageSize,
      template_name: selTpl.name,
      cost: selTpl.cost || 10
    })
  })
  .then(r => r.json())
  .then(data => {
    if(data.task_id){
      lbl.textContent = '–ì–ï–ù–ï–†–ò–†–£–ï–ú ‚è≥';
      pollTask(data.task_id, userId, btn, lbl);
    } else { throw new Error(); }
  })
  .catch(() => {
    btn.disabled = false;
    lbl.textContent = '–°–û–ó–î–ê–¢–¨ ¬∑ ' + selTpl.cost + ' –≥–µ–Ω.';
    toast('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'err');
  });
}

function pollTask(taskId, userId, btn, lbl){
  var attempts = 0;
  var maxAttempts = 60;
  var timer = setInterval(function(){
    attempts++;
    fetch(BACKEND_URL + '/task/' + taskId + '?telegram_user_id=' + userId)
      .then(r => r.json())
      .then(data => {
        if(data.state === 'success'){
          clearInterval(timer);
          btn.disabled = false;
          lbl.textContent = '–°–û–ó–î–ê–¢–¨ ¬∑ ' + (selTpl?selTpl.cost:10) + ' –≥–µ–Ω.';
          // –æ–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫
          if(selTpl){selTpl.uses=(selTpl.uses||0)+1;saveTpl();renderTemplates();}
          // –¥–æ–±–∞–≤–ª—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω—É—é –∏—Å—Ç–æ—Ä–∏—é
          addToHistory({id:Date.now(),name:selTpl?selTpl.name:'–ì–µ–Ω–µ—Ä–∞—Ü–∏—è',preview:data.result_url||null,tplName:selTpl?selTpl.name:'',createdAt:Date.now()});
          closeOverlay('tmplOvl');
          if(data.result_url) showResult(data.result_url, selTpl?selTpl.name:'');
          else toast('‚úÖ '+(selTpl?selTpl.name:'–ì–µ–Ω–µ—Ä–∞—Ü–∏—è')+' –≥–æ—Ç–æ–≤–∞!','ok');
        } else if(data.state === 'fail' || attempts >= maxAttempts){
          clearInterval(timer);
          btn.disabled = false;
          lbl.textContent = '–°–û–ó–î–ê–¢–¨ ¬∑ ' + (selTpl?selTpl.cost:10) + ' –≥–µ–Ω.';
          toast(data.state==='fail'?'‚ùå –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–µ —É–¥–∞–ª–∞—Å—å':'‚è± –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è','err');
        }
      })
      .catch(function(){if(attempts>=maxAttempts)clearInterval(timer);});
  }, 3000);
}

function showResult(url, name){
  var el = document.createElement('div');
  el.id = 'resultPopup';
  el.style.cssText = 'position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.93);display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;';
  el.innerHTML = '<div style="font-family:Barlow Condensed,sans-serif;font-size:14px;font-weight:700;letter-spacing:2px;color:var(--y);margin-bottom:14px;">‚úÖ '+(name||'–ì–û–¢–û–í–û')+'</div>'
    +'<img src="'+url+'" style="max-width:100%;max-height:65vh;border-radius:12px;border:1px solid rgba(255,255,255,.1);">'
    +'<div style="display:flex;gap:10px;margin-top:16px;width:100%;">'
    +'<button onclick="document.getElementById(\'resultPopup\').remove()" style="flex:1;height:44px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:transparent;color:rgba(255,255,255,.6);font-family:Barlow Condensed,sans-serif;font-size:14px;font-weight:700;letter-spacing:1px;cursor:pointer;">–ó–ê–ö–†–´–¢–¨</button>'
    +'<a href="'+url+'" download="nano-banano.png" style="flex:1;height:44px;border-radius:10px;border:none;background:var(--y);color:#000;font-family:Barlow Condensed,sans-serif;font-size:14px;font-weight:700;letter-spacing:1px;cursor:pointer;display:flex;align-items:center;justify-content:center;text-decoration:none;">‚¨á –°–ö–ê–ß–ê–¢–¨</a>'
    +'</div>';
  document.body.appendChild(el);
}

// ‚ïê‚ïê HISTORY ‚ïê‚ïê
var HISTORY_TTL = 7 * 24 * 60 * 60 * 1000; // 7 –¥–Ω–µ–π –≤ –º—Å

function loadHistory(){
  var raw = JSON.parse(localStorage.getItem('nb_history')||'[]');
  var now = Date.now();
  // —É–¥–∞–ª—è–µ–º —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ
  var fresh = raw.filter(function(h){ return (now - h.createdAt) < HISTORY_TTL; });
  if(fresh.length !== raw.length) localStorage.setItem('nb_history', JSON.stringify(fresh));
  return fresh;
}

function addToHistory(item){
  var hist = loadHistory();
  hist.unshift(item);
  // –Ω–µ —Ö—Ä–∞–Ω–∏–º base64 –ø—Ä–µ–≤—å—é –¥–æ–ª—å—à–µ –Ω—É–∂–Ω–æ–≥–æ ‚Äî –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 20 –∑–∞–ø–∏—Å–µ–π
  if(hist.length > 20) hist = hist.slice(0, 20);
  localStorage.setItem('nb_history', JSON.stringify(hist));
  renderHistory();
}

function fmtAgo(ts){
  var diff = Date.now() - ts;
  var m = Math.floor(diff/60000);
  var h = Math.floor(diff/3600000);
  var d = Math.floor(diff/86400000);
  if(m < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
  if(m < 60) return m+'–º –Ω–∞–∑–∞–¥';
  if(h < 24) return h+'—á –Ω–∞–∑–∞–¥';
  return d+'–¥ –Ω–∞–∑–∞–¥';
}

function fmtExpiry(ts){
  var exp = ts + HISTORY_TTL;
  var diff = exp - Date.now();
  var d = Math.floor(diff/86400000);
  var h = Math.floor((diff%86400000)/3600000);
  if(d > 0) return '—É–¥–∞–ª–∏—Ç—Å—è —á–µ—Ä–µ–∑ '+d+'–¥';
  if(h > 0) return '—É–¥–∞–ª–∏—Ç—Å—è —á–µ—Ä–µ–∑ '+h+'—á';
  return '—Å–∫–æ—Ä–æ —É–¥–∞–ª–∏—Ç—Å—è';
}

function renderHistory(){
  var hist = loadHistory();
  var empty = document.getElementById('history-empty');
  var grid = document.getElementById('history-grid');
  if(!grid) return;
  if(!hist.length){
    if(empty) empty.style.display='block';
    grid.innerHTML='';
    return;
  }
  if(empty) empty.style.display='none';
  grid.innerHTML = hist.map(function(h){
    var prevHtml = h.preview
      ? '<img src="'+h.preview+'" style="width:100%;height:100%;object-fit:cover;position:absolute;inset:0;">'
      : '<div style="display:flex;align-items:center;justify-content:center;width:100%;height:100%;font-size:28px;opacity:.3">üñº</div>';
    return '<div class="tcard" style="position:relative;">'
      +'<div class="tcard-media" style="aspect-ratio:1/1;position:relative;overflow:hidden;background:#111">'
      + prevHtml
      +'</div>'
      +'<div class="tcard-body">'
      +'<div class="tcard-name">'+h.name+'</div>'
      +'<div class="tcard-meta">'
      +'<div class="use-c" style="font-size:10px;color:var(--mu2)">'+fmtAgo(h.createdAt)+'</div>'
      +'<div style="font-size:9px;color:rgba(255,77,109,.6);font-family:Barlow Condensed,sans-serif;letter-spacing:.5px;">'+fmtExpiry(h.createdAt)+'</div>'
      +'</div>'
      +'</div>'
      +'</div>';
  }).join('');
}

// ‚ïê‚ïê TAB ACTIONS ‚ïê‚ïê
function doCreate(){const p=document.getElementById('createPrompt').value.trim();if(!p){toast('–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–ø—Ç','err');return}toast('‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞!','ok')}
function doEdit(){toast('‚úÖ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ!','ok')}
function doUpscale(){toast('‚úÖ –ê–ø—Å–∫–µ–π–ª '+upLevel+' –∑–∞–ø—É—â–µ–Ω!','ok')}

// ‚ïê‚ïê SHOP ‚ïê‚ïê
function openShop(){openOverlay('shopOvl')}
function buyPlan(p){closeOverlay('shopOvl');toast('üí≥ –û–ø–ª–∞—Ç–∞ '+p+'...')}

// ‚ïê‚ïê OVERLAYS ‚ïê‚ïê
function openOverlay(id){var el=document.getElementById(id);if(el)el.classList.add('open');document.body.style.overflow='hidden';}
function closeOverlay(id){var el=document.getElementById(id);if(el)el.classList.remove('open');document.body.style.overflow='';}
function ovlClose(e,id){if(e.target.id===id)closeOverlay(id)}

// ‚ïê‚ïê ADMIN ‚ïê‚ïê
function openAdmin(){syncCatSelect();renderAdmList();updateStats();document.getElementById('adminPanel').classList.add('open')}
function closeAdmin(){document.getElementById('adminPanel').classList.remove('open')}
function updateStats(){
  document.getElementById('stat-t').textContent=templates.length;
  document.getElementById('stat-a').textContent=templates.filter(t=>t.active).length;
}

// EMOJI PICKER
function initEmojiPicker(){
  const p=document.getElementById('emojiPicker');
  p.innerHTML=CAT_EMOJIS.map(function(e){var cls='ep-emoji'+(e===selectedCatEmoji?' sel':'');return '<span class="'+cls+'" onclick="pickCatEmoji(&apos;'+e+'&apos;)">'+e+'</span>';}).join('');
}
function toggleEmojiPicker(){
  const p=document.getElementById('emojiPicker');
  p.classList.toggle('open');
  if(p.classList.contains('open'))initEmojiPicker();
}
function pickCatEmoji(e){
  selectedCatEmoji=e;
  document.getElementById('catEmojiPreview').textContent=e;
  document.querySelectorAll('.ep-emoji').forEach(el=>{el.classList.toggle('sel',el.textContent===e)});
  document.getElementById('emojiPicker').classList.remove('open');
}

// CATEGORIES
function addCategory(){
  const label=document.getElementById('newCatLabel').value.trim();
  if(!label){toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ','err');return}
  if(categories.find(c=>c.label.toLowerCase()===label.toLowerCase())){toast('–£–∂–µ –µ—Å—Ç—å','err');return}
  const map={–∞:'a',–±:'b',–≤:'v',–≥:'g',–¥:'d',–µ:'e',—ë:'e',–∂:'zh',–∑:'z',–∏:'i',–π:'y',–∫:'k',–ª:'l',–º:'m',–Ω:'n',–æ:'o',–ø:'p',—Ä:'r',—Å:'s',—Ç:'t',—É:'u',—Ñ:'f',—Ö:'h',—Ü:'ts',—á:'ch',—à:'sh',—â:'sch',—ä:'',—ã:'y',—å:'',—ç:'e',—é:'yu',—è:'ya'};
  const id=label.toLowerCase().split('').map(ch=>map[ch]||(/[a-z0-9]/.test(ch)?ch:'_')).join('').replace(/_+/g,'_').replace(/^_|_$/g,'')+'_'+Date.now().toString(36).slice(-4);
  categories.push({id,label:label.toUpperCase(),emoji:''});
  saveCats();renderCatsBar();renderCatAdmList();syncCatSelect();
  document.getElementById('newCatLabel').value='';
  toast('‚úÖ –ö–∞—Ç–µ–≥–æ—Ä–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞!','ok');
}
function delCategory(id){
  if(id==='all'){toast('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å','err');return}
  categories=categories.filter(c=>c.id!==id);saveCats();renderCatsBar();renderCatAdmList();syncCatSelect();
}
function renderCatAdmList(){
  const el=document.getElementById('catAdmList');
  el.innerHTML=categories.filter(function(c){return c.id!=='all';}).map(function(c){
    return '<div class="cat-adm-chip">'+c.label+'<span class="cac-del" onclick="delCategory(\''+c.id+'\')">‚úï</span></div>';
  }).join('');
}
function syncCatSelect(){
  const s=document.getElementById('nCat');
  s.innerHTML=categories.filter(function(c){return c.id!=='all';}).map(function(c){return '<option value="'+c.id+'">'+c.label+'</option>';}).join('');
}

// TEMPLATE TYPE
function selTtype(el,type){
  if(!el)return;
  document.querySelectorAll('.ttype-opt').forEach(function(o){o.classList.remove('on');});
  el.classList.add('on');selectedTtype=type;
  var n={'single':1,'double':2,'triple':3,'quad':4}[type]||1;
  document.getElementById('lbl2row').style.display=n>=2?'':'none';
  document.getElementById('lbl3row').style.display=n>=3?'':'none';
  document.getElementById('lbl4row').style.display=n>=4?'':'none';
}

// ADMIN MEDIA
function setAdmMedia(t){
  const pi=document.getElementById('admTypeImg'),pv=document.getElementById('admTypeVid');
  document.getElementById('admFile').accept=t==='image'?'image/*':'video/*';
  if(t==='image'){pi.classList.add('on');pv.classList.remove('on')}else{pi.classList.remove('on');pv.classList.add('on')}
}
function handleAdmPreview(input){
  const f=input.files[0];if(!f)return;
  const img=document.getElementById('prevImg'),vid=document.getElementById('prevVid');
  if(f.type.startsWith('video/')){img.style.display='none';vid.src=URL.createObjectURL(f);vid.style.display='block';vid.play()}
  else{vid.style.display='none';const r=new FileReader();r.onload=e=>{img.src=e.target.result;img.style.display='block'};r.readAsDataURL(f)}
}

// ADD TEMPLATE
function addTemplate(){
  var name=document.getElementById('nName').value.trim();
  if(!name){alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ!');return;}
  
  var catId=document.getElementById('nCat').value;
  var cost=parseInt(document.getElementById('nCost').value)||10;
  var ratio=(document.getElementById('nRatio')||{}).value||'9:16';
  
  var img=document.getElementById('prevImg');
  var vid=document.getElementById('prevVid');
  var preview=null, previewType='image';
  if(vid&&vid.src&&vid.src.length>10&&vid.src!==window.location.href){
    preview=vid.src; previewType='video';
  } else if(img&&img.src&&img.src.length>10&&img.src!==window.location.href&&img.style.display!=='none'){
    preview=img.src; previewType='image';
  }

  var tpl={
    id:Date.now(),
    name:name,
    emoji:'üé®',
    description:document.getElementById('nDesc').value.trim(),
    type:selectedTtype||'single',
    lbl1:document.getElementById('nLbl1').value.trim()||'–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à–µ —Ñ–æ—Ç–æ',
    lbl2:document.getElementById('nLbl2').value.trim()||'–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤—Ç–æ—Ä–æ–µ —Ñ–æ—Ç–æ',
    lbl3:document.getElementById('nLbl3').value.trim()||'–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ç—Ä–µ—Ç—å–µ —Ñ–æ—Ç–æ',
    lbl4:document.getElementById('nLbl4').value.trim()||'–ó–∞–≥—Ä—É–∑–∏—Ç–µ —á–µ—Ç–≤—ë—Ä—Ç–æ–µ —Ñ–æ—Ç–æ',
    prompt:document.getElementById('nPrompt').value.trim(),
    category:catId||'hairstyle',
    cost:cost,
    defaultRatio:ratio,
    active:true,
    preview:preview,
    previewType:previewType,
    uses:0
  };

  templates.unshift(tpl);
  saveTpl();

  // reset form
  ['nName','nDesc','nLbl1','nLbl2','nLbl3','nLbl4','nPrompt'].forEach(function(i){
    var el=document.getElementById(i); if(el) el.value='';
  });
  document.getElementById('nCost').value='10';
  if(img){img.style.display='none'; img.src='';}
  if(vid){vid.style.display='none'; vid.src='';}

  // force show all
  curCat='all';
  renderCatsBar();
  renderAdmList();
  renderTemplates('all');
  updateStats();
  toast('‚úÖ –®–∞–±–ª–æ–Ω –¥–æ–±–∞–≤–ª–µ–Ω: '+name,'ok');
}


function renderAdmList(){
  const c=document.getElementById('admList');
  if(!templates.length){c.innerHTML='<div class="empty"><div class="ei">üì≠</div>–®–∞–±–ª–æ–Ω–æ–≤ –Ω–µ—Ç</div>';return}
  c.innerHTML=templates.map(function(t){
    var photoCount={'single':1,'double':2,'triple':3,'quad':4}[t.type]||1;
    return '<div class="adm-item">'
      +'<div class="adm-thumb">'+thumbHtml(t.preview,t.previewType,'‚óà')+'</div>'
      +'<div class="adm-info">'
      +'<div class="adm-name">'+t.name+'</div>'
      +'<div class="adm-meta">'+catL(t.category)+' ¬∑ ‚ö° '+t.cost+' ¬∑ '+photoCount+'—Ñ–æ—Ç–æ ¬∑ '+(t.defaultRatio||'9:16')+'</div>'
      +'</div>'
      +'<div class="adm-actions">'
      +'<button class="adm-edit-btn" onclick="openEditSheet('+t.id+')" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">—Ä–µ–¥</button>'
      +'<div class="toggle '+(t.active?'on':'')+'" onclick="toggleT('+t.id+')"></div>'
      +'<button class="del-btn" onclick="deleteT('+t.id+')">‚úï</button>'
      +'</div>'
      +'</div>';
  }).join('');
}
function toggleT(id){const t=templates.find(x=>x.id===id);if(!t)return;t.active=!t.active;saveTpl();renderAdmList();renderTemplates();updateStats()}
function deleteT(id){
  const t=templates.find(x=>x.id===id);if(!t)return;
  document.getElementById('confirmSubText').textContent='¬´'+t.name+'¬ª ‚Äî —ç—Ç–æ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å';
  document.getElementById('confirmOkBtn').onclick=()=>{
    templates=templates.filter(x=>x.id!==id);
    saveTpl();renderAdmList();renderTemplates();updateStats();
    closeConfirm();toast('üóë –£–¥–∞–ª–µ–Ω–æ');
  };
  document.getElementById('confirmModal').classList.add('open');
}
function closeConfirm(){document.getElementById('confirmModal').classList.remove('open')}

// ‚ïê‚ïê EDIT TEMPLATE SHEET ‚ïê‚ïê
let editMediaNew=null,editMediaTypeNew=null;

function openEditSheet(id){
  const t=templates.find(x=>x.id===id);if(!t)return;
  // sync cat select
  const es=document.getElementById('eCat');
  es.innerHTML=categories.filter(function(c){return c.id!=='all';}).map(function(c){return '<option value="'+c.id+'">'+c.label+'</option>';}).join('');
  // fill fields
  document.getElementById('editTplId').value=id;
  document.getElementById('editSheetSub').textContent=t.name;
  document.getElementById('eName').value=t.name||'';
  document.getElementById('eDesc').value=t.description||'';
  document.getElementById('eLbl1').value=t.lbl1||'';
  document.getElementById('eLbl2').value=t.lbl2||'';
  document.getElementById('ePrompt').value=t.prompt||'';
  document.getElementById('eCost').value=t.cost||10;
  document.getElementById('eRatio').value=t.defaultRatio||'9:16';
  // set category
  es.value=t.category;
  // set type
  document.getElementById('eType').value=t.type||'single';
  document.querySelectorAll('[data-etype]').forEach(function(o){
    o.classList.toggle('on', o.dataset.etype===(t.type||'single'));
  });
  var n={'single':1,'double':2,'triple':3,'quad':4}[t.type||'single']||1;
  document.getElementById('eLbl2row').style.display=n>=2?'':'none';
  document.getElementById('eLbl3row').style.display=n>=3?'':'none';
  document.getElementById('eLbl4row').style.display=n>=4?'':'none';
  // fill lbl3/lbl4
  document.getElementById('eLbl3').value=t.lbl3||'';
  document.getElementById('eLbl4').value=t.lbl4||'';
  // preview
  const img=document.getElementById('editPrevImg'),vid=document.getElementById('editPrevVid');
  img.style.display='none';vid.style.display='none';
  editMediaNew=null;editMediaTypeNew=null;
  if(t.preview){
    if(t.previewType==='video'){vid.src=t.preview;vid.style.display='block';setEditMediaBtn('video')}
    else{img.src=t.preview;img.style.display='block';setEditMediaBtn('image')}
    document.getElementById('editPrevIco').style.opacity='0';
    document.getElementById('editPrevTxt').style.opacity='0';
  }else{
    document.getElementById('editPrevIco').style.opacity='.4';
    document.getElementById('editPrevTxt').style.opacity='1';
    setEditMediaBtn('image');
  }
  document.getElementById('editTplSheet').classList.add('open');
  document.body.style.overflow='hidden';
}

function closeEditSheet(){
  document.getElementById('editTplSheet').classList.remove('open');
  document.body.style.overflow='';
}
function selEtype(el,type){
  document.querySelectorAll('[data-etype]').forEach(function(o){o.classList.remove('on');});
  el.classList.add('on');
  document.getElementById('eType').value=type;
  var n={'single':1,'double':2,'triple':3,'quad':4}[type]||1;
  document.getElementById('eLbl2row').style.display=n>=2?'':'none';
  document.getElementById('eLbl3row').style.display=n>=3?'':'none';
  document.getElementById('eLbl4row').style.display=n>=4?'':'none';
}
function editSheetBgClose(e){if(e.target.id==='editTplSheet')closeEditSheet()}

function setEditMedia(t){setEditMediaBtn(t);document.getElementById('editAdmFile').accept=t==='image'?'image/*':'video/*'}
function setEditMediaBtn(t){
  const pi=document.getElementById('editAdmTypeImg'),pv=document.getElementById('editAdmTypeVid');
  if(t==='image'){pi.classList.add('on');pv.classList.remove('on')}else{pi.classList.remove('on');pv.classList.add('on')}
}
function handleEditPreview(input){
  const f=input.files[0];if(!f)return;
  const img=document.getElementById('editPrevImg'),vid=document.getElementById('editPrevVid');
  document.getElementById('editPrevIco').style.opacity='0';
  document.getElementById('editPrevTxt').style.opacity='0';
  if(f.type.startsWith('video/')){
    editMediaTypeNew='video';
    img.style.display='none';vid.src=URL.createObjectURL(f);vid.style.display='block';vid.play();
    const rd=new FileReader();rd.onload=e=>{editMediaNew=e.target.result};rd.readAsDataURL(f);
  }else{
    editMediaTypeNew='image';
    vid.style.display='none';
    const rd=new FileReader();rd.onload=e=>{img.src=e.target.result;img.style.display='block';editMediaNew=e.target.result};rd.readAsDataURL(f);
  }
}

function saveEditTemplate(){
  const id=parseInt(document.getElementById('editTplId').value);
  const t=templates.find(x=>x.id===id);if(!t)return;
  const name=document.getElementById('eName').value.trim();
  if(!name){toast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ','err');return}
  t.name=name;
  t.description=document.getElementById('eDesc').value.trim();
  t.type=document.getElementById('eType').value||'single';
  t.lbl1=document.getElementById('eLbl1').value.trim()||'–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤–∞—à–µ —Ñ–æ—Ç–æ';
  t.lbl2=document.getElementById('eLbl2').value.trim()||'–ó–∞–≥—Ä—É–∑–∏—Ç–µ –≤—Ç–æ—Ä–æ–µ —Ñ–æ—Ç–æ';
  t.lbl3=document.getElementById('eLbl3').value.trim()||'–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ç—Ä–µ—Ç—å–µ —Ñ–æ—Ç–æ';
  t.lbl4=document.getElementById('eLbl4').value.trim()||'–ó–∞–≥—Ä—É–∑–∏—Ç–µ —á–µ—Ç–≤—ë—Ä—Ç–æ–µ —Ñ–æ—Ç–æ';
  t.prompt=document.getElementById('ePrompt').value.trim();
  t.category=document.getElementById('eCat').value;
  t.cost=parseInt(document.getElementById('eCost').value)||10;
  t.defaultRatio=document.getElementById('eRatio').value;
  // update preview if new one uploaded
  if(editMediaNew){t.preview=editMediaNew;t.previewType=editMediaTypeNew}
  // update emoji from category
  const cat=categories.find(c=>c.id===t.category);
  if(cat)t.emoji=cat.emoji||t.emoji;
  saveTpl();renderAdmList();renderTemplates();
  closeEditSheet();toast('‚úÖ –®–∞–±–ª–æ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω!','ok');
}

// ‚ïê‚ïê TOAST ‚ïê‚ïê
let _tt;
function toast(msg,type=''){
  const el=document.getElementById('toast');el.textContent=msg;el.className='toast show '+(type||'');
  clearTimeout(_tt);_tt=setTimeout(()=>el.className='toast',2400);
}

// ‚ïê‚ïê MULTI PHOTO (edit tab) ‚ïê‚ïê
const multiPhotos=[null,null,null,null];

function triggerMultiFile(idx){
  const slot=document.getElementById('mzs-'+idx);
  if(slot.classList.contains('locked'))return;
  if(slot.classList.contains('has-img')){return} // click on del btn handles removal
  document.getElementById('mzf-'+idx).click();
}

function addMultiPhoto(input,idx){
  const f=input.files[0];if(!f)return;
  const slot=document.getElementById('mzs-'+idx);
  const reader=new FileReader();
  reader.onload=e=>{
    multiPhotos[idx]=e.target.result;
    // build slot content
    slot.innerHTML='<img class="mz-img" src="'+e.target.result+'">'
      +'<div class="mz-del" onclick="removeMultiPhoto(event,'+idx+')">‚úï</div>'
      +'<div class="mz-num">'+(idx+1)+'</div>'
      +'<input type="file" id="mzf-'+idx+'" accept="image/*,video/*" style="display:none" onchange="addMultiPhoto(this,'+idx+')">';
    slot.classList.add('has-img');
    // unlock next slot
    if(idx<3){
      const next=document.getElementById('mzs-'+(idx+1));
      next.classList.remove('locked');
      next.querySelector('svg').style.stroke='rgba(245,200,0,.35)';
    }
  };
  reader.readAsDataURL(f);
}

function removeMultiPhoto(e,idx){
  e.stopPropagation();
  multiPhotos[idx]=null;
  const slot=document.getElementById('mzs-'+idx);
  slot.innerHTML='<svg viewBox="0 0 24 24" width="22" height="22" stroke="rgba(245,200,0,.35)" fill="none"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></svg>'
    +'<span>–§–æ—Ç–æ '+(idx+1)+'</span>'
    +'<input type="file" id="mzf-'+idx+'" accept="image/*,video/*" style="display:none" onchange="addMultiPhoto(this,'+idx+')">';
  slot.classList.remove('has-img');
  // lock subsequent empty slots
  for(let i=idx+1;i<4;i++){
    if(!multiPhotos[i]){
      const s=document.getElementById('mzs-'+i);
      s.classList.add('locked');
      s.querySelector('svg')&&(s.querySelector('svg').style.stroke='rgba(90,88,96,.5)');
    }
  }
}

// ‚ïê‚ïê INIT ‚ïê‚ïê
function init(){
  var step='';
  try{
    step='checkAdmin'; checkAdmin();
    step='renderCatsBar'; renderCatsBar();
    step='renderTemplates'; renderTemplates();
    step='updateStats'; updateStats();
    step='buildRatios-create'; buildRatios('ratioCreate');
    step='buildRatios-edit'; buildRatios('ratioEdit');
    step='syncCatSelect'; syncCatSelect();
    step='renderCatAdmList'; renderCatAdmList();
    step='selTtype';
    var _defOpt=document.querySelector('.ttype-opt[data-type="single"]');
    if(_defOpt)selTtype(_defOpt,'single');
    step='tg-init';
    try{var tg=window.Telegram&&window.Telegram.WebApp;if(tg){tg.ready();tg.expand();}}catch(e){}
    step='syncBalance'; syncBalance();
  }catch(err){
    var div=document.createElement('div');
    div.style.cssText='position:fixed;bottom:40px;left:0;right:0;background:#8B0000;color:#fff;padding:12px;font-size:12px;z-index:9999;word-break:break-all';
    div.textContent='STEP: '+step+' | '+err.message;
    document.body.appendChild(div);
  }
}
init();
</script>
</body>
</html>
